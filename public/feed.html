<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gram√°tike</title>
    <link href="https://fonts.googleapis.com/css2?family=Mansalva&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f3f4f6; }
        
        /* Navigation - Estiliza√ß√£o do cabe√ßalho roxo, avatar e arredondamento */
        nav {
            background: linear-gradient(90deg, #c08adc 0%, #a76bc4 100%);
            border: none;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 6px rgba(0,0,0,0.12);
            border-radius: 0 0 24px 24px;
        }
        nav .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        nav h1 {
            font-family: 'Mansalva', cursive;
            color: white;
            font-size: 26px;
            letter-spacing: .5px;
            text-shadow: 0 1px 0 #a76bc4;
        }
        nav .actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        nav a, nav button {
            text-decoration: none;
            color: #fff;
            font-size: 14px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        nav a:hover, nav button:hover { background: rgba(255,255,255,0.16); }
        nav .logout { color: #fee !important; border: 1px solid #fff; }
        nav .logout:hover { background: #fee !important; color: #c33 !important; }

        /* Avatar √† direita no cabe√ßalho */
        .avatar-circulo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #fff;
            box-shadow: 0 1px 4px rgba(160, 63, 220, 0.15);
            margin-left: 18px;
            cursor: pointer;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .avatar-circulo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Main container arredondado branco */
        .container {
            max-width: 800px;
            margin: 24px auto;
            padding: 0 16px;
        }
        .container-bg {
            background: white;
            border-radius: 32px;
            box-shadow: 0 1px 6px rgba(160, 63, 220, 0.05);
            padding: 36px 24px 24px;
            margin-bottom: 24px;
        }

        /* Create post form */
        .create-post { background: transparent; border-radius: 16px; padding: 0; margin-bottom: 20px; box-shadow: none; }
        .create-post textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 12px; font-size: 14px; resize: vertical; min-height: 80px; font-family: inherit; }
        .create-post textarea:focus { outline: none; border-color: #c08adc; box-shadow: 0 0 0 3px rgba(192, 138, 220, 0.1); }
        .create-post button { margin-top: 12px; padding: 10px 24px; background: #c08adc; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .create-post button:hover:not(:disabled) { background: #a76bc4; }
        .create-post button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Posts */
        .post { background: #f8fafc; border-radius: 20px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
        .post-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .post-author { font-weight: 600; color: #111827; }
        .post-username { color: #6b7280; font-size: 14px; margin-left: 8px; }
        .post-date { color: #9ca3af; font-size: 13px; }
        .post-content { color: #374151; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .post-actions { margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; }
        .post-actions button { background: none; border: none; color: #dc2626; cursor: pointer; padding: 6px 12px; border-radius: 8px; font-size: 13px; transition: all 0.2s; }
        .post-actions button:hover { background: #fee; }
        
        /* Messages */
        .error, .success { padding: 12px 16px; border-radius: 12px; margin-bottom: 16px; font-size: 14px; display: none; }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; }
        .error.show { display: block; }
        .success { background: #efe; border: 1px solid #cfc; color: #3c3; }
        .success.show { display: block; }
        
        /* Loading & Empty states */
        .loading, .empty { text-align: center; padding: 40px; color: #6b7280; }
        .loading { display: none; }
        .loading.show { display: block; }
        .empty { display: none; }
        .empty.show { display: block; }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <h1>Gram√°tike</h1>
            <div class="actions">
                <a href="/feed">Feed</a>
                <a href="/admin" id="admin-link" style="display:none;">Admin</a>
                <button class="logout" onclick="handleLogout()">Sair</button>
                <div id="avatar-container" class="avatar-circulo" style="display:none;">
                  <!-- Avatar ser√° exibido aqui via JS -->
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="container-bg">
            <div id="error" class="error"></div>
            <div id="success" class="success"></div>
            <!-- Create Post Form -->
            <div class="create-post">
                <form onsubmit="handleCreatePost(event)">
                    <textarea id="post-content" placeholder="O que voc√™ est√° pensando?" required maxlength="5000"></textarea>
                    <button type="submit" id="create-btn">Publicar</button>
                </form>
            </div>
            <!-- Posts Feed -->
            <div id="posts"></div>
            <div id="loading" class="loading">Carregando...</div>
            <div id="empty" class="empty">Nenhum post ainda. Seja o primeiro a postar!</div>
        </div>
    </div>

    <script>
        let currentUser = null;

        function showError(msg) {
            const el = document.getElementById('error');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function showSuccess(msg) {
            const el = document.getElementById('success');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 7) return date.toLocaleDateString('pt-BR');
            if (days > 0) return `${days}d atr√°s`;
            if (hours > 0) return `${hours}h atr√°s`;
            if (minutes > 0) return `${minutes}min atr√°s`;
            return 'agora';
        }

        async function loadPosts() {
            const loading = document.getElementById('loading');
            const empty = document.getElementById('empty');
            const postsContainer = document.getElementById('posts');
            
            loading.classList.add('show');
            empty.classList.remove('show');
            
            try {
                const res = await fetch('/api/posts');
                if (!res.ok) throw new Error('Erro ao carregar posts');
                
                const data = await res.json();
                const posts = data.posts || [];
                
                loading.classList.remove('show');
                
                if (posts.length === 0) {
                    empty.classList.add('show');
                    return;
                }
                
                postsContainer.innerHTML = posts.map(post => `
                    <div class="post">
                        <div class="post-header">
                            <div>
                                <span class="post-author">${escapeHtml(post.name || post.username)}</span>
                                <span class="post-username">@${escapeHtml(post.username)}</span>
                                <div class="post-date">${formatDate(post.created_at)}</div>
                            </div>
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        ${currentUser && currentUser.is_admin ? `
                            <div class="post-actions">
                                <button onclick="deletePost(${post.id})">üóëÔ∏è Deletar</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            } catch (err) {
                loading.classList.remove('show');
                showError(err.message);
            }
        }

        async function handleCreatePost(e) {
            e.preventDefault();
            
            const content = document.getElementById('post-content').value.trim();
            if (!content) return;
            
            const btn = document.getElementById('create-btn');
            btn.disabled = true;
            btn.textContent = 'Publicando...';
            
            try {
                const res = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erro ao criar post');
                }
                
                document.getElementById('post-content').value = '';
                showSuccess('Post publicado!');
                await loadPosts();
            } catch (err) {
                showError(err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Publicar';
            }
        }

        async function deletePost(id) {
            if (!confirm('Tem certeza que deseja deletar este post?')) return;
            
            try {
                const res = await fetch(`/api/posts/${id}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erro ao deletar post');
                }
                
                showSuccess('Post deletado!');
                await loadPosts();
            } catch (err) {
                showError(err.message);
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (err) {
                showError('Erro ao fazer logout');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Exibir avatar no cabe√ßalho e link do perfil
        function showAvatar(user){
            if(user && user.avatar_url){
                const avatarEl = document.getElementById('avatar-container');
                avatarEl.innerHTML = `<a href="/perfil"><img src="${user.avatar_url}" alt="Foto do perfil"></a>`;
                avatarEl.style.display = 'flex';
            }
        }

        // Check if user is authenticated
        async function checkAuth() {
            try {
                const res = await fetch('/api/users/me');
                if (!res.ok) {
                    window.location.href = '/';
                    return;
                }
                const data = await res.json();
                currentUser = data.user;
                
                // Exibir avatar no cabe√ßalho
                showAvatar(currentUser);

                // Show admin link if user is admin
                if (currentUser.is_admin) {
                    document.getElementById('admin-link').style.display = 'block';
                }
            } catch (err) {
                window.location.href = '/';
            }
        }

        // Initialize
        (async () => {
            await checkAuth();
            await loadPosts();
        })();
    </script>
</body>
</html>
