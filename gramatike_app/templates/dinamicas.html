<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dinâmicas — Gramátike Edu</title>
  <link href="https://fonts.googleapis.com/css2?family=Mansalva&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#9B5DE5; --border:#e5e7eb; --card:#fff; --bg:#f7f8ff; --text:#222; }
    body { margin:0; font-family:'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header.site-head { background:#9B5DE5; padding:28px clamp(16px,4vw,40px) 46px; border-bottom-left-radius:40px; border-bottom-right-radius:40px; position:relative; display:flex; flex-direction:column; align-items:center; }
    .logo { font-family:'Mansalva', cursive; font-size:2.4rem; color:#fff; font-weight:400; margin:0; }
    main { width:100%; max-width:980px; margin:2rem auto 4rem; padding:0 clamp(16px,4vw,40px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:1rem 1.2rem; box-shadow:0 10px 24px -8px rgba(0,0,0,.10); }
    .muted { color:#666; font-weight:600; }
    .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.6rem 1rem; border-radius:10px; border:1px solid var(--border); cursor:pointer; font-family:'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; font-weight:800; letter-spacing:.3px; background:#fff; color:#6233B5; }
    .btn.primary { background:#9B5DE5; color:#fff; border:none; }
    .row { display:grid; grid-template-columns: 1fr; gap:.4rem; }
    .builder-card { background:#fff; border:1px solid var(--border); border-radius:16px; padding:.8rem; margin:.4rem 0; }
    .builder-actions { display:flex; gap:.4rem; }
    .muted-sm { font-size:.8rem; color:#666; }
    .opt-row { display:flex; gap:.4rem; align-items:center; margin:.25rem 0; }
    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .55rem; border-radius:14px; border:1px solid var(--border); background:#fafafa; font-size:.75rem; font-weight:800; color:#6233B5; }
  </style>
</head>
<body>
  <header class="site-head">
    <h1 class="logo">Dinâmicas</h1>
  </header>
  <main>
    {% if not is_admin %}
      <div class="card">
        <p class="muted">Recurso em beta — disponível apenas para administradores no momento.</p>
      </div>
    {% else %}
      <div class="card" style="margin-bottom:1rem;">
        <h2 style="margin:0 0 .6rem; font-size:1.2rem; color:#6233B5;">Criar dinâmica</h2>
        <form id="dynCreateForm" method="POST" action="{{ url_for('main.dinamicas_create') }}" enctype="multipart/form-data" style="display:grid; gap:.6rem; grid-template-columns:1fr; font-family:'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
          <label style="font-weight:800; color:#6233B5;">Tipo</label>
          <select name="tipo" id="tipo" required>
            <option value="poll">Enquete</option>
            <option value="oneword">Nuvem de Palavras</option>
            <option value="form">Formulário (simples)</option>
            <option value="quemsoeu">Quem sou eu?</option>
          </select>
          <label style="font-weight:800; color:#6233B5;">Título</label>
          <input type="text" name="titulo" required />
          <label style="font-weight:800; color:#6233B5;">Descrição (opcional)</label>
          <textarea name="descricao" rows="2"></textarea>
          <div id="poll_opts">
            <label style="font-weight:800; color:#6233B5;">Opções (1 por linha)</label>
            <textarea name="opcoes" rows="3" placeholder="Opção A&#10;Opção B"></textarea>
          </div>
          <div id="form_builder" style="display:none;">
            <div class="muted-sm">Adicione perguntas como no Google Forms. Tipos: resposta curta, parágrafo, múltipla escolha.</div>
            <div id="q_list"></div>
            <div class="builder-actions">
              <button type="button" class="btn" id="add_q">+ Pergunta</button>
            </div>
            <input type="hidden" name="config_json" id="config_json" />
          </div>
          <div id="quemsoeu_builder" style="display:none;">
            <div class="muted-sm">Adicione frases ou fotos que os participantes terão que responder. Escolha o que eles devem descobrir (gênero, orientação, pronome, etc.).</div>
            <label style="font-weight:800; color:#6233B5; margin-top:.8rem;">O que a pessoa deve descobrir?</label>
            <input type="text" name="questao_tipo" id="questao_tipo" placeholder="Ex: gênero, orientação sexual, pronome..." />
            <label style="font-weight:800; color:#6233B5; margin-top:.8rem;">Moral/Mensagem Final</label>
            <textarea name="moral" id="moral" rows="3" placeholder="Mensagem que aparecerá ao final da dinâmica..."></textarea>
            <div id="items_list" style="margin-top:1rem;"></div>
            <div class="builder-actions">
              <button type="button" class="btn" id="add_item">+ Item (Frase ou Foto)</button>
            </div>
            <input type="hidden" name="quemsoeu_config_json" id="quemsoeu_config_json" />
          </div>
          <button type="submit" class="btn primary">Criar</button>
        </form>
      </div>
      <div class="card">
        <h3 style="margin:.2rem 0 .6rem; color:#6233B5;">Minhas dinâmicas</h3>
        {% if (my_dynamics or [])|length == 0 %}
          <p class="muted">Nenhuma dinâmica criada ainda.</p>
        {% else %}
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
            {% for d in my_dynamics %}
              <div class="builder-card" style="display:flex; flex-direction:column; gap:.4rem;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                  <div style="font-weight:800; color:#222;">{{ d.titulo }}</div>
                  <div style="display:flex; gap:.3rem; align-items:center;">
                    <span class="chip">{{ d.tipo }}</span>
                    {% if d.active %}
                      <span class="chip" style="background:#d4edda; color:#155724; border-color:#c3e6cb;">Ativa</span>
                    {% else %}
                      <span class="chip" style="background:#f8d7da; color:#721c24; border-color:#f5c6cb;">Finalizada</span>
                    {% endif %}
                  </div>
                </div>
                {% if d.descricao %}<div class="muted-sm">{{ d.descricao }}</div>{% endif %}
                <div style="display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.25rem;">
                  <a class="btn" href="{{ url_for('main.dinamica_admin', dyn_id=d.id) }}">Ver respostas</a>
                  <a class="btn" href="{{ url_for('main.dinamica_view', dyn_id=d.id) }}">Abrir</a>
                  <a class="btn" href="{{ url_for('main.dinamica_export_csv', dyn_id=d.id) }}">Baixar CSV</a>
                  <a class="btn" href="{{ url_for('main.dinamica_edit', dyn_id=d.id) }}">Editar</a>
                  <form method="POST" action="{{ url_for('main.dinamica_toggle_active', dyn_id=d.id) }}" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
                    <button type="submit" class="btn" style="{% if d.active %}background:#28a745;color:#fff;{% else %}background:#dc3545;color:#fff;{% endif %}">
                      {% if d.active %}Finalizar{% else %}Ativar{% endif %}
                    </button>
                  </form>
                  <form method="POST" action="{{ url_for('main.dinamica_delete', dyn_id=d.id) }}" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta dinâmica? Esta ação não pode ser desfeita.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
                    <button type="submit" class="btn" style="background:#dc3545;color:#fff;">
                      Excluir
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </main>
  <script>
  (function(){
    const tipo = document.getElementById('tipo');
    const poll = document.getElementById('poll_opts');
    const builder = document.getElementById('form_builder');
    const quemsoeuBuilder = document.getElementById('quemsoeu_builder');
    const qList = document.getElementById('q_list');
    const addBtn = document.getElementById('add_q');
    const cfgEl = document.getElementById('config_json');
    const form = document.getElementById('dynCreateForm');

    let seq = 1;
    const fields = [];

    // Quem sou eu? state
    const itemsList = document.getElementById('items_list');
    const addItemBtn = document.getElementById('add_item');
    const quemsoeuCfgEl = document.getElementById('quemsoeu_config_json');
    let itemSeq = 1;
    const items = [];

    function renderItems(){
      itemsList.innerHTML='';
      items.forEach((item, idx)=>{
        const card = document.createElement('div');
        card.className = 'builder-card';
        card.innerHTML = `
          <div class="row">
            <div style="display:flex; gap:.5rem; align-items:center;">
              <span class="chip">Item ${idx+1}</span>
              <select data-k="tipo" style="flex:0 0 auto;">
                <option value="frase" ${item.tipo==='frase'?'selected':''}>Frase</option>
                <option value="foto" ${item.tipo==='foto'?'selected':''}>Foto</option>
              </select>
              <button type="button" class="btn" data-act="del-item">Remover</button>
            </div>
            <div data-role="frase-input" style="${item.tipo==='frase'?'':'display:none;'}">
              <label style="font-weight:600; margin-top:.5rem; display:block;">Frase</label>
              <textarea data-k="conteudo" rows="2" style="width:100%;">${item.conteudo||''}</textarea>
            </div>
            <div data-role="foto-input" style="${item.tipo==='foto'?'':'display:none;'}">
              <label style="font-weight:600; margin-top:.5rem; display:block;">Foto</label>
              <input type="file" data-k="foto" data-item-id="${item.id}" accept="image/*" style="width:100%;" />
              ${item.conteudo ? `<div class="muted-sm" style="margin-top:.3rem;">Já carregada: <a href="${item.conteudo}" target="_blank">ver foto</a></div>` : ''}
            </div>
            <div style="margin-top:.5rem;">
              <label style="font-weight:600; display:block;">Resposta Correta (opcional - para cálculo de acertos)</label>
              <input type="text" data-k="resposta_correta" value="${item.resposta_correta||''}" style="width:100%;" placeholder="Ex: masculino, feminino, não-binário..." />
            </div>
          </div>`;
        
        // bind events
        card.querySelectorAll('input,select,textarea').forEach(el=>{
          el.addEventListener('change', (e)=>{
            const k = el.getAttribute('data-k');
            if(!k) return;
            if(k==='tipo'){ 
              item.tipo = el.value; 
              card.querySelector('[data-role="frase-input"]').style.display = (item.tipo==='frase')?'block':'none';
              card.querySelector('[data-role="foto-input"]').style.display = (item.tipo==='foto')?'block':'none';
            }
            else if(k==='conteudo'){ item.conteudo = el.value; }
            else if(k==='resposta_correta'){ item.resposta_correta = el.value; }
            else if(k==='foto'){
              // Set name attribute so backend can read it
              el.name = 'foto_' + item.id;
            }
          });
          // Set initial name for file inputs
          if(el.getAttribute('data-k') === 'foto'){
            el.name = 'foto_' + item.id;
          }
        });
        card.querySelector('[data-act="del-item"]').addEventListener('click', ()=>{ items.splice(idx,1); renderItems(); });
        itemsList.appendChild(card);
      });
    }

    function addItem(){
      items.push({ id: itemSeq++, tipo: 'frase', conteudo: '', resposta_correta: '' });
      renderItems();
    }

    addItemBtn && addItemBtn.addEventListener('click', addItem);

    function render(){
      qList.innerHTML='';
      fields.forEach((f, idx)=>{
        const card = document.createElement('div');
        card.className = 'builder-card';
        card.innerHTML = `
          <div class="row">
            <div style="display:flex; gap:.5rem; align-items:center;">
              <span class="chip">Q${idx+1}</span>
              <input type="text" placeholder="Pergunta" value="${f.label||''}" data-k="label" style="flex:1;"/>
              <select data-k="type">
                <option value="short" ${f.type==='short'?'selected':''}>Resposta curta</option>
                <option value="paragraph" ${f.type==='paragraph'?'selected':''}>Parágrafo</option>
                <option value="multiple_choice" ${f.type==='multiple_choice'?'selected':''}>Múltipla escolha</option>
              </select>
              <label class="muted-sm" style="display:flex; align-items:center; gap:.3rem;">
                <input type="checkbox" data-k="required" ${f.required?'checked':''}/> Obrigatória
              </label>
              <button type="button" class="btn" data-act="del">Remover</button>
            </div>
            <div data-role="options" style="${f.type==='multiple_choice'?'':'display:none;'}">
              <div class="muted-sm">Opções:</div>
              <div class="opt-list"></div>
              <button type="button" class="btn" data-act="addopt">+ opção</button>
            </div>
          </div>`;
        // bind
        card.querySelectorAll('input,select,textarea').forEach(el=>{
          el.addEventListener('change', (e)=>{
            const k = el.getAttribute('data-k');
            if(!k) return;
            if(k==='required'){ f.required = !!el.checked; }
            else if(k==='label'){ f.label = el.value; }
            else if(k==='type'){ f.type = el.value; card.querySelector('[data-role="options"]').style.display = (f.type==='multiple_choice')?'block':'none'; }
          });
        });
        card.querySelector('[data-act="del"]').addEventListener('click', ()=>{ fields.splice(idx,1); render(); });
        const optWrap = card.querySelector('.opt-list');
        function renderOpts(){
          optWrap.innerHTML = '';
          (f.options||[]).forEach((o, i)=>{
            const row = document.createElement('div');
            row.className = 'opt-row';
            row.innerHTML = `<span class="muted-sm">${String.fromCharCode(65+i)})</span> <input type="text" value="${o}" style="flex:1;"/> <button type="button" class="btn" data-i="${i}">remover</button>`;
            row.querySelector('input').addEventListener('input', (e)=>{ f.options[i] = e.target.value; });
            row.querySelector('button').addEventListener('click', ()=>{ f.options.splice(i,1); renderOpts(); });
            optWrap.appendChild(row);
          });
        }
        renderOpts();
        card.querySelector('[data-act="addopt"]').addEventListener('click', ()=>{ f.options = f.options||[]; f.options.push(''); renderOpts(); });
        qList.appendChild(card);
      });
    }
    function addQuestion(){
      fields.push({ id: seq++, type: 'short', label: '', required: false, options: [] });
      render();
    }
    addBtn && addBtn.addEventListener('click', addQuestion);
    tipo.addEventListener('change', ()=>{
      const v = tipo.value;
      poll.style.display = (v==='poll')?'block':'none';
      builder.style.display = (v==='form')?'block':'none';
      quemsoeuBuilder.style.display = (v==='quemsoeu')?'block':'none';
    });
    // on submit serialize
    form.addEventListener('submit', ()=>{
      if(tipo.value==='form'){
        const cfg = { fields: fields.map(f=>({ id: f.id, type: f.type, label: f.label, required: !!f.required, options: (f.type==='multiple_choice'?(f.options||[]):undefined) })) };
        cfgEl.value = JSON.stringify(cfg);
      }
      if(tipo.value==='quemsoeu'){
        // For photos, file inputs will be sent separately with names foto_<item_id>
        const cfg = { items: items.map(item=>({ id: item.id, tipo: item.tipo, conteudo: item.conteudo, resposta_correta: item.resposta_correta || '' })) };
        quemsoeuCfgEl.value = JSON.stringify(cfg);
      }
    });
  })();
  </script>
</body>
</html>
