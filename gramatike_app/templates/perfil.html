<!DOCTYPE html>
<html lang="pt-BR">
<head>
<style>
:root { --font-base:'Nunito', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; --font-brand:'Mansalva', cursive; }
body, p, label, input, button, a, span, li, td, th, div, h1, h2, h3, h4, h5, h6 { font-family: var(--font-base) !important; }
</style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gramátike — Perfil</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/icons/icon-192.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Mansalva&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.6rem 1rem; border-radius:10px; border:none; cursor:pointer; font-family:'Nunito'; font-weight:700; letter-spacing:.3px; transition:filter .15s ease, transform .05s ease; }
  .btn:active { transform: translateY(1px); }
  .btn-primary { background:#9B5DE5; color:#fff; }
  .btn-primary:hover { filter:brightness(1.08); }
    body, p, label, input, button, a, span, li, td, th, div, h1, h2, h3, h4, h5, h6 {
      font-family: 'Nunito', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif !important;
    }
    :root {
      --primary: #4a6fa5;
      --secondary: #f0f4f8;
      --success: #a5d6a7;
      --danger: #e57373;
      --text: #333;
      --text-secondary: #666;
    }

    html, body { height:100%; overflow-x:hidden; }
    body {
      margin: 0;
      padding: 0;
      background-color: var(--secondary);
      color: var(--text);
      display:flex; flex-direction:column; min-height:100vh;
    }

  header.site-head { background:#9B5DE5; padding:18px clamp(16px,4vw,40px) 28px; border-bottom-left-radius:35px; border-bottom-right-radius:35px; position:relative; display:flex; flex-direction:column; align-items:center; }
  .logo { font-family: var(--font-brand) !important; font-size:2.5rem; color:#fff; letter-spacing:1px; font-weight:400; }
  /* Avatar do usuário no cabeçalho */
  .profile-avatar-link { position:absolute; right:24px; top:50%; transform:translateY(-50%); display:inline-flex; align-items:center; justify-content:center; width:58px; height:58px; border-radius:50%; border:3px solid #ffffff55; box-shadow:0 4px 14px rgba(0,0,0,.25); overflow:hidden; background:#ffffff22; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); cursor:pointer; text-decoration:none; transition: box-shadow .25s, transform .18s; }
  .profile-avatar-link:hover { box-shadow:0 6px 20px rgba(0,0,0,.32); }
  .profile-avatar-link:active { transform:translateY(-50%) scale(.95); }
  .profile-avatar-link img { width:100%; height:100%; object-fit:cover; display:block; }
  .profile-avatar-link span.initial { font-size:1.9rem; font-weight:800; color:#fff; letter-spacing:.5px; }
  /* Tooltip simples acessível */
  .profile-avatar-link[data-tooltip]:hover::after, .profile-avatar-link[data-tooltip]:focus-visible::after { content:attr(data-tooltip); position:absolute; bottom:-6px; left:50%; transform:translate(-50%,100%); background:#222; color:#fff; font-size:.6rem; font-weight:600; padding:4px 7px 5px; border-radius:8px; white-space:nowrap; box-shadow:0 4px 12px rgba(0,0,0,.35); letter-spacing:.5px; }
  @media (max-width:640px){ .profile-avatar-link { width:46px; height:46px; right:16px; } .profile-avatar-link span.initial { font-size:1.4rem; } }
    .head-actions { position:absolute; right:16px; top:50%; transform:translateY(-50%); display:flex; gap:.5rem; }
    .icon-btn { width:40px; height:40px; border-radius:12px; display:inline-flex; align-items:center; justify-content:center; background:#ffffff22; border:1px solid #ffffff44; color:#fff; text-decoration:none; font-size:18px; font-weight:700; box-shadow:0 4px 14px rgba(0,0,0,.25); }
    .icon-btn:hover { background:#ffffff33; }

    nav a {
      margin-left: 1rem;
      text-decoration: none;
      color: var(--text);
      font-weight: 500;
    }

    nav a:hover {
      color: var(--primary);
    }

    main {
      max-width: none;
      margin: 2rem 0;
      padding: 0 24px;
      flex:1 0 auto;
    }

    .profile-header {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      width: 50%;
      margin-left: auto;
      margin-right: auto;
    }

    .avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--secondary);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 3rem;
      color: var(--primary);
    }

    .profile-info h2 {
      font-size: 1.4rem;
      margin: 0;
      color: #333;
  font-family: 'Nunito';
      letter-spacing: .5px;
      font-weight:600;
    }

    .profile-info p { margin: 0.3rem 0; color: var(--text-secondary); }

    .edit-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 0.5rem;
  font-family: 'Nunito';
      font-weight:600;
      letter-spacing:.3px;
    }

    .edit-btn:hover {
      background: #3b5a85;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      border-bottom: 2px solid #ddd;
      width: 50%;
      margin-left: auto;
      margin-right: auto;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .tab.active {
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
    }

    .tab-content {
      background: white;
      padding: 1.5rem;
      margin-top: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      width: 50%;
      margin-left: auto;
      margin-right: auto;
    }

    /* Post action buttons - matching index.html */
    .post-actions { display:flex; gap:1.2rem; }
    .post-actions button { cursor:pointer; border:none; border-radius:28px; padding:.45rem .9rem; font-weight:600; font-size:.8rem; display:flex; align-items:center; gap:.35rem; transition: background-color .2s, transform .15s; }
    .post-actions button:active { transform: translateY(1px); }
    .likes-list { margin-bottom:.9rem; font-size:.9rem; color: var(--text-secondary); font-weight:500; }
    .like-btn-perfil { background:#ede7ff; color: #9B5DE5; box-shadow: 0 4px 10px rgba(130,87,229,0.25); border:1px solid #d3c5ff; border-radius:28px; padding:.45rem .9rem; font-weight:600; font-size:.8rem; }
    .like-btn-perfil:hover, .like-btn-perfil.liked { background: #9B5DE5; color:#fff; box-shadow: 0 6px 16px rgba(130,87,229,0.45); border-color: #9B5DE5; }
    .comment-btn-perfil { background: #9B5DE5; color:#fff; box-shadow: 0 5px 15px rgba(130,87,229,0.6); border-radius:28px; padding:.45rem .9rem; font-weight:600; font-size:.8rem; }
    .comment-btn-perfil:hover { background: #7d3dc9; box-shadow: 0 8px 25px rgba(111,72,201,0.9); }
    .toggle-comments-btn-perfil { background:#f1edff; color:#9B5DE5; border:1px solid #d8ccff; padding:.45rem 1rem; font-size:.7rem; font-weight:700; border-radius:40px; cursor:pointer; letter-spacing:.5px; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    .toggle-comments-btn-perfil:hover { background:#9B5DE5; color:#fff; border-color:#9B5DE5; }

    @media (max-width: 900px) {
      .profile-header, .tabs, .tab-content { width: 100%; }
    }

    @media (max-width: 900px) {
      .tab-content { width: 100%; }
    }

    .post {
      border-bottom: 1px solid #eee;
      padding: 1rem 0;
    }

    .post:last-child {
      border-bottom: none;
    }

    footer {
      text-align: center;
      padding: 1rem;
      margin-top: auto;
      color: var(--text-secondary);
    }
    
    @media (max-width: 980px){
      footer {
        display: none !important;
      }
      
      /* Hide back button on mobile */
      .back-btn {
        display: none !important;
      }
      
      /* Fix post overflow on mobile */
      .post {
        max-width: 100% !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
      }
      
      .post p, .post strong, .post span {
        max-width: 100% !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
      }
      
      /* Fix post menu positioning on mobile */
      .post-menu {
        right: 0 !important;
        left: auto !important;
      }
    }

    /* Estilos para o modal de edição */
    #modal-editar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
      padding: 1.5rem 1rem;
    }

    #form-editar-perfil {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }

    #form-editar-perfil label {
      display: block;
      margin-bottom: 1rem;
      color: var(--text);
    }

    #form-editar-perfil input, #form-editar-perfil textarea, #form-editar-perfil select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #form-editar-perfil button {
      margin-top: 1rem;
    }

    /* Post media styles for images with cover (Twitter-style) */
    .post-media img { width:100%; display:block; border-radius:24px; margin:.6rem 0 1.1rem; object-fit:cover; max-height:380px; cursor:pointer; }
    .post-media { position:relative; overflow:hidden; }
    .post-media.multi { display:grid; gap:8px; margin:.6rem 0 1.1rem; }
    .post-media.multi.grid-2 { grid-template-columns:repeat(2,1fr); }
    .post-media.multi.grid-3 { grid-template-columns:repeat(3,1fr); }
    .post-media.multi.grid-4 { grid-template-columns:repeat(2,1fr); }
    .post-media.multi .pm-item img { margin:0; height:180px; border-radius:16px; object-fit:cover; cursor:pointer; }
  </style>
</head>
<body>
  <header class="site-head">
    <h1 class="logo">Gramátike</h1>
    <div class="head-actions">
      <a href="javascript:history.back()" class="icon-btn back-btn" title="Voltar" aria-label="Voltar">⬅️</a>
      <a href="{{ url_for('main.configuracoes') }}" class="icon-btn" title="Configurações" aria-label="Configurações">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
      </a>
    </div>
  </header>

  <main>
    <section class="profile-header">
      <div class="avatar">
        {% if usuario.foto_perfil %}
          {% set fp = usuario.foto_perfil %}
          {% set is_abs = fp.startswith('http://') or fp.startswith('https://') %}
          {% set is_static = fp.startswith('/static/') %}
          <img src="{{ fp if (is_abs or is_static) else url_for('static', filename=fp) }}" alt="Foto de perfil" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
        {% else %}
          <span>👤</span>
        {% endif %}
      </div>
      <div class="profile-info">
  <h2 style="font-family: var(--font-brand); font-weight:400; letter-spacing:1px;">@{{ usuario.username }}</h2>
        <div style="display:flex;gap:1.5rem;margin-bottom:0.7rem;">
          <span id="cnt-seguidores"><b>0</b> seguidories</span>
          <span id="cnt-seguindo"><b>0</b> seguindo</span>
        </div>
        <p><strong></strong> <span style="color:#666">{{ usuario.nome or '' }}</span></p>
  {# Exibir gênero/pronome somente se não for 'Outro' #}
  {% set g = usuario.genero if (usuario.genero and usuario.genero != 'Outro') else '' %}
  {% set p = usuario.pronome if (usuario.pronome and usuario.pronome != 'Outro') else '' %}
  {% if g or p %}
  <p><strong></strong> <span style="color:#666">{{ g }}{% if g and p %} / {% endif %}{{ p }}</span></p>
  {% endif %}
        {% if usuario.bio and not (usuario.genero == 'Outro' and usuario.pronome == 'Outro') %}
          <p style="margin-top:0.5rem;color:#444;font-style:italic;white-space:pre-line;">{{ usuario.bio }}</p>
        {% endif %}
        <div style="margin-top:.7rem;">
          {% if current_user.id == usuario.id %}
            <button class="edit-btn" onclick="abrirEdicaoPerfil()">Editar Perfil</button>
          {% else %}
            {% set seguindo = usuario in current_user.seguindo %}
            <button id="btn-follow" data-state="{{ 'following' if seguindo else 'not' }}" onclick="toggleFollow('{{ usuario.id }}')" style="color:#fff; border:none; padding:.5rem 1rem; border-radius:6px; cursor:pointer; font-weight:600; background:#4a6fa5;">{{ 'Deixar de seguir' if seguindo else 'Seguir' }}</button>
          {% endif %}
        </div>
      </div>
    </section>

    <div class="tabs">
      <div class="tab active" onclick="mostrarAba('postagens')">Postagens</div>
  <div class="tab" onclick="mostrarAba('seguidores')">Seguidories</div>
      <div class="tab" onclick="mostrarAba('seguindo')">Seguindo</div>
    </div>

    <div id="tab-content" class="tab-content">
      <!-- Conteúdo inicial: postagens -->
      <div id="postagens">
        <p>Carregando postagens...</p>
      </div>
    </div>

    {% if current_user.id == usuario.id %}
    <!-- Modal para edição de perfil (mesmo layout de meu_perfil) -->
    <div id="modal-editar" style="display:none;">
      <form id="form-editar-perfil" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
        <div style="display:flex;flex-direction:column;gap:0.7rem;">
          <label style="margin-bottom:0.3rem;">Usuárie:
            <input type="text" name="username" value="{{ current_user.username }}" readonly style="width:100%;">
          </label>
          <label style="margin-bottom:0.3rem;">Nome:
            <input type="text" name="nome" value="{{ current_user.nome or '' }}" style="width:100%;">
          </label>
          <label style="margin-bottom:0.3rem;">Email:
            <input type="email" name="email" value="{{ current_user.email }}" style="width:100%;">
          </label>
          <label style="margin-bottom:0.3rem;">Bio:
            <textarea name="bio" style="width:100%;resize:vertical;min-height:40px;">{{ current_user.bio or '' }}</textarea>
          </label>
          <label style="margin-bottom:0.3rem;">Data de nascimento:
            <input type="date" name="data_nascimento" value="{{ current_user.data_nascimento or '' }}" style="width:100%;">
          </label>
          <label style="margin-bottom:0.3rem;">Gênero:
            <select name="genero" required style="width:100%;">
              <option value="">Selecione</option>
              <option value="Não-binárie" {% if current_user.genero == 'Não-binárie' %}selected{% endif %}>Não-binárie</option>
              <option value="Mulher" {% if current_user.genero == 'Mulher' %}selected{% endif %}>Mulher</option>
              <option value="Homem" {% if current_user.genero == 'Homem' %}selected{% endif %}>Homem</option>
              <option value="Outro" {% if current_user.genero == 'Outro' %}selected{% endif %}>Outro</option>
            </select>
          </label>
          <label style="margin-bottom:0.3rem;">Pronome:
            <select name="pronome" required style="width:100%;">
              <option value="">Selecione</option>
              <option value="elu/delu" {% if current_user.pronome == 'elu/delu' %}selected{% endif %}>elu/delu</option>
              <option value="ela/dela" {% if current_user.pronome == 'ela/dela' %}selected{% endif %}>ela/dela</option>
              <option value="ele/dele" {% if current_user.pronome == 'ele/dele' %}selected{% endif %}>ele/dele</option>
              <option value="Outro" {% if current_user.pronome == 'Outro' %}selected{% endif %}>Outro</option>
            </select>
          </label>
          <label style="margin-bottom:0.3rem;">Foto de perfil:
            <input type="file" name="foto_perfil" accept="image/*" style="width:100%;">
          </label>
          <div style="display:flex;gap:0.5rem;">
            <button type="submit" class="btn btn-primary" style="flex:1;">Salvar</button>
            <button type="button" class="btn btn-primary" onclick="fecharEdicaoPerfil()" style="flex:1;">Cancelar</button>
          </div>
        </div>
      </form>
    </div>
    {% endif %}
  </main>

  <!-- Barra de navegação inferior mobile (tipo app/rede social) -->
  <style>
    /* Barra de navegação inferior para mobile */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
      box-shadow: 0 -4px 12px rgba(0,0,0,.08);
      z-index: 1000;
    }

    @media (max-width: 980px){
      .mobile-bottom-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
      }
      
      main {
        margin-bottom: calc(60px + env(safe-area-inset-bottom)) !important;
        padding: 0 12px !important;
      }
      
      .profile-header {
        width: 100% !important;
        flex-direction: column !important;
        text-align: center !important;
        padding: 1.5rem 1rem !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
      }
      
      .profile-info {
        align-items: center !important;
        max-width: 100% !important;
        overflow-wrap: break-word !important;
      }
      
      .profile-info h2,
      .profile-info p {
        max-width: 100% !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
      }
      
      /* Fix stats display on mobile */
      .profile-info div[style*="display:flex"] {
        gap: 0.8rem !important;
        font-size: 0.85rem !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
      }
      
      .profile-actions {
        width: 100% !important;
        flex-direction: column !important;
      }
      
      .profile-actions button,
      .profile-actions .btn {
        width: 100% !important;
      }
      
      .profile-content {
        width: 100% !important;
        padding: 0 !important;
      }
      
      .tabs {
        flex-wrap: wrap !important;
        gap: 0.3rem !important;
        width: 100% !important;
        justify-content: center !important;
      }
      
      .tab {
        flex: 0 1 auto !important;
        min-width: 30% !important;
        font-size: 0.7rem !important;
        padding: 0.5rem 0.6rem !important;
        text-align: center !important;
      }
      
      .tab-content {
        width: 100% !important;
        padding: 0.8rem !important;
        overflow-wrap: break-word !important;
      }
      
      footer {
        display: none !important;
      }
    }

    .mobile-bottom-nav a {
      all: unset;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 12px;
      cursor: pointer;
      color: #666;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.3px;
      transition: color 0.2s;
      text-decoration: none;
    }

    .mobile-bottom-nav a:active {
      transform: scale(0.95);
    }

    .mobile-bottom-nav a svg {
      color: #666;
      transition: color 0.2s;
    }

    .mobile-bottom-nav a:hover {
      color: var(--primary);
    }

    .mobile-bottom-nav a:hover svg {
      color: var(--primary);
    }
  </style>
  
  <nav class="mobile-bottom-nav" aria-label="Navegação principal mobile">
    <a href="{{ url_for('main.index') }}" aria-label="Feed" title="Feed">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
      <span>Início</span>
    </a>
    
    <a href="{{ url_for('main.educacao') }}" aria-label="Educação" title="Educação">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
      </svg>
      <span>Educação</span>
    </a>
    
    <a href="{{ url_for('main.novo_post') }}" aria-label="Criar post" title="Criar post" style="background: var(--primary); color: white; border-radius: 50%; width: 48px; height: 48px; margin: -10px 0; padding: 0; display: flex; align-items: center; justify-content: center; flex-direction: row;">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    </a>
    
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 6px 12px; color: #666; font-size: 0.65rem; font-weight: 600; letter-spacing: 0.3px; text-decoration: none;">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      <span>Em breve</span>
    </div>
    
    <a href="{{ url_for('main.meu_perfil') }}" aria-label="Perfil" title="Perfil" style="color: var(--primary);">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <span>Perfil</span>
    </a>
  </nav>

  <footer>
  © 2025 Gramátike • Inclusão e Gênero Neutro
  </footer>

  <script>

    window.VIEW_USER_ID = "{{ usuario.id|tojson|safe }}";
    window.CURRENT_USER_ID = "{{ current_user.id|tojson|safe }}";

    // Renderiza imagens (uma ou múltiplas) separadas por '|'
    function renderPostImages(raw){
      if(!raw) return '';
      const parts = raw.split('|').filter(Boolean);
      if(!parts.length) return '';
      // Helper: determinar src correto (URL ou path local)
      const getSrc = (path) => /^https?:\/\//i.test(path) ? path : `/static/${path}`;
      if(parts.length === 1){
        const src = getSrc(parts[0]);
        return `<div class="post-media"><img src="${src}" alt="Imagem do post" onclick="openImageModal('${src}')" onerror="this.style.display='none'"/></div>`;
      }
      // Grid simples para múltiplas
      const cls = parts.length===2? 'grid-2' : (parts.length===3? 'grid-3':'grid-4');
      const imgs = parts.map(p=>{
        const src = getSrc(p);
        return `<div class="pm-item"><img src="${src}" alt="Imagem do post" onclick="openImageModal('${src}')" onerror="this.style.display='none'"/></div>`;
      }).join('');
      return `<div class="post-media multi ${cls}">${imgs}</div>`;
    }

    function mostrarAba(aba) {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      if (aba === 'postagens') {
        carregarPostagensUsuario();
      } else if (aba === 'seguidores') {
        fetch(`/api/seguidores/${window.VIEW_USER_ID}`)
          .then(res => res.json())
          .then(lista => {
            let html = '<b>Seguidories</b><div style="margin-top:0.7rem;display:flex;flex-direction:column;gap:.35rem;">';
            if (lista.length === 0) html += '<div style="color:#666;font-size:.85rem;">Nenhume seguidore ainda.</div>';
            else html += lista.map(u => `
              <div class=\"seg-item\" data-username=\"${u.username}\" style=\"display:flex;align-items:center;gap:.55rem;cursor:pointer;padding:.35rem .5rem;border:1px solid #eee;border-radius:6px;background:#fafafa;\">
                <div style=\"width:32px;height:32px;border-radius:50%;background:#4a6fa522;display:flex;align-items:center;justify-content:center;font-weight:600;color:#4a6fa5;\">${u.username.charAt(0).toUpperCase()}</div>
                <div style=\"display:flex;flex-direction:column;line-height:1.1;\">
                  <span style=\"font-weight:600;color:#333;\">@${u.username}</span>
                  ${u.nome ? `<span style='font-size:.65rem;color:#777;'>${u.nome}</span>` : ''}
                </div>
              </div>`).join('');
            html += '</div>';
            document.getElementById('tab-content').innerHTML = html;
          });
      } else if (aba === 'seguindo') {
        fetch(`/api/seguindo/${window.VIEW_USER_ID}`)
          .then(res => res.json())
          .then(lista => {
            let html = '<b>Seguindo</b><div style="margin-top:0.7rem;display:flex;flex-direction:column;gap:.35rem;">';
            if (lista.length === 0) html += '<div style="color:#666;font-size:.85rem;">Não segue ninguém ainda.</div>';
            else html += lista.map(u => `
              <div class=\"seg-item\" data-username=\"${u.username}\" style=\"display:flex;align-items:center;gap:.55rem;cursor:pointer;padding:.35rem .5rem;border:1px solid #eee;border-radius:6px;background:#fafafa;\">
                <div style=\"width:32px;height:32px;border-radius:50%;background:#4a6fa522;display:flex;align-items:center;justify-content:center;font-weight:600;color:#4a6fa5;\">${u.username.charAt(0).toUpperCase()}</div>
                <div style=\"display:flex;flex-direction:column;line-height:1.1;\">
                  <span style=\"font-weight:600;color:#333;\">@${u.username}</span>
                  ${u.nome ? `<span style='font-size:.65rem;color:#777;'>${u.nome}</span>` : ''}
                </div>
              </div>`).join('');
            html += '</div>';
            document.getElementById('tab-content').innerHTML = html;
          });
      }
    }

    function carregarPostagensUsuario() {
      const userId = window.VIEW_USER_ID;
      fetch(`/api/posts/usuario/${userId}`)
        .then(res => res.json())
        .then(posts => {
          let html = '';
          if (!posts || posts.length === 0) {
            html = '<p style="color:#888;text-align:center;">Nenhuma postagem encontrada.</p>';
          } else {
            html = posts.map(p => `
              <div class='post' data-post-id='${p.id}' style='position:relative;'>
                <div class='post-header' style="display:flex;align-items:center;justify-content:space-between;">
                  <div style="display:flex;align-items:center;gap:0.7rem;">
                    <img src="${(p.foto_perfil && (p.foto_perfil.startsWith('http://') || p.foto_perfil.startsWith('https://'))) ? p.foto_perfil : ('/static/' + (p.foto_perfil || 'img/perfil.png'))}" alt="Foto de perfil" class="post-avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #eee;cursor:pointer;">
                    <span style="cursor:pointer;" class="post-username"><strong>@${p.usuario}</strong> <span style='color:#888;'>${p.data}</span></span>
                  </div>
                  <div class='post-menu-container' style='position:relative;'>
                    <button class='post-menu-btn' aria-label='Ações' style='background:none;border:none;font-size:1.3rem;cursor:pointer;color:#555;line-height:1;'>⋯</button>
                    <div class='post-menu' style='display:none; position:absolute; top:28px; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; padding:.35rem 0; box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:40; min-width:140px;'>
                      ${p.can_delete ? `<button class='pm-excluir' style='display:block;width:100%;background:none;border:none;text-align:left;padding:.5rem .9rem;font-size:.7rem;cursor:pointer;'>Excluir</button>`:''}
                      <button class='pm-compartilhar' style='display:block;width:100%;background:none;border:none;text-align:left;padding:.5rem .9rem;font-size:.7rem;cursor:pointer;'>Compartilhar</button>
                    </div>
                  </div>
                </div>
                <p style='white-space:pre-line;margin:.6rem 0 .3rem;'>${p.conteudo}</p>
                ${ (p.images && p.images.length) ? renderPostImages(p.images.join('|')) : (p.imagem ? renderPostImages(p.imagem) : '') }
                <div class='likes-list' style='font-size:.9rem;margin:.4rem 0;'></div>
                <div class='post-actions'>
                  <button class='like-btn-perfil' data-post-id='${p.id}'>❤️ Curtir</button>
                  <button class='comment-btn-perfil' data-post-id='${p.id}'>💬 Comentar</button>
                  <button class='toggle-comments-btn-perfil' data-post-id='${p.id}'>↓</button>
                </div>
                <div class='comments-list' data-post-id='${p.id}' style='display:none;margin-top:.6rem;'></div>
              </div>`).join('');
          }
          document.getElementById('tab-content').innerHTML = `<div id='postagens'>${html}</div>`;
          inicializarMenusPostsPerfil();
        });
    }

    function inicializarMenusPostsPerfil(){
      document.querySelectorAll('.post-menu-btn').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          const menu=btn.parentElement.querySelector('.post-menu');
          const open=menu.style.display==='block';
          document.querySelectorAll('.post-menu').forEach(m=>m.style.display='none');
          menu.style.display=open?'none':'block';
        });
      });
      document.addEventListener('click', ()=>{
        document.querySelectorAll('.post-menu').forEach(m=>m.style.display='none');
      });
      document.querySelectorAll('.pm-excluir').forEach(b=>{
        b.addEventListener('click', e=>{
          e.stopPropagation();
          const div=b.closest('.post');
          const id=div.getAttribute('data-post-id');
          if(confirm('Excluir este post?')){
            fetch(`/api/posts/${id}`, {method:'DELETE'}).then(r=>{ if(r.ok){ div.remove(); }});
          }
        });
      });
      document.querySelectorAll('.pm-compartilhar').forEach(b=>{
        b.addEventListener('click', e=>{
          e.stopPropagation();
          const div=b.closest('.post');
          const id=div.getAttribute('data-post-id');
          const shareUrl = window.location.origin + '/perfil/{{ usuario.id }}#post-' + id;
          navigator.clipboard.writeText(shareUrl).then(()=>alert('Link copiado.'));
        });
      });

      // Like button functionality
      document.querySelectorAll('.like-btn-perfil').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          const postId = btn.getAttribute('data-post-id');
          fetch(`/api/posts/${postId}/like`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
              if (data.liked) {
                btn.classList.add('liked');
                btn.textContent = '❤️ Curtido';
              } else {
                btn.classList.remove('liked');
                btn.textContent = '❤️ Curtir';
              }
              updateLikesDisplayPerfil(postId, btn.closest('.post'));
            });
        });
      });

      // Comment button functionality
      document.querySelectorAll('.comment-btn-perfil').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          showCommentBoxPerfil(btn);
        });
      });

      // Toggle comments button functionality
      document.querySelectorAll('.toggle-comments-btn-perfil').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          const postId = btn.getAttribute('data-post-id');
          toggleCommentsPerfil(btn, postId);
        });
      });

      // Load likes for each post
      document.querySelectorAll('.post').forEach(post=>{
        const postId = post.getAttribute('data-post-id');
        updateLikesDisplayPerfil(postId, post);
      });
    }

    function updateLikesDisplayPerfil(postId, postElem) {
      fetch(`/api/posts/${postId}/likes`)
        .then(res => res.json())
        .then(users => {
          let likesDiv = postElem.querySelector('.likes-list');
          if (!likesDiv) {
            likesDiv = document.createElement('div');
            likesDiv.className = 'likes-list';
            likesDiv.style.cssText = 'font-size:.7rem;margin:.4rem 0;';
            const actionsDiv = postElem.querySelector('.like-btn-perfil').parentElement;
            postElem.insertBefore(likesDiv, actionsDiv);
          }
          if (users.length === 0) {
            likesDiv.innerHTML = '';
          } else {
            const currentUser = '{{ current_user.username if current_user.is_authenticated else "" }}';
            const curtiu = users.includes(currentUser);
            likesDiv.innerHTML = `<span style="color:#666;">`+
              (curtiu ? '<strong style="color:#7c3aed;">Você</strong>' : '') +
              (curtiu && users.length > 1 ? ' e ' : '') +
              users.filter(u => u !== currentUser).slice(0, 2).join(', ') +
              (users.length > 3 ? ` e mais ${users.length - 3}` : '') +
              ' curtiram</span>';
          }
        });
    }

    function showCommentBoxPerfil(btn) {
      const postElem = btn.closest('.post');
      let box = postElem.querySelector('.comment-box');
      if (!box) {
        box = document.createElement('div');
        box.className = 'comment-box';
        box.style.cssText = 'margin-top:.6rem;display:flex;gap:.5rem;flex-direction:column;';
        box.innerHTML = `
          <textarea class="comment-input" placeholder="Escreva um comentário..." style="border:1px solid #ddd;border-radius:8px;padding:.6rem;font-size:.75rem;resize:vertical;min-height:60px;"></textarea>
          <button onclick="submitCommentPerfil(this)" style="align-self:flex-end;background:#9B5DE5;color:#fff;border:none;border-radius:6px;padding:.4rem .8rem;font-size:.75rem;cursor:pointer;">Enviar</button>
        `;
        postElem.appendChild(box);
      } else {
        box.remove();
      }
    }

    function submitCommentPerfil(btn) {
      const textarea = btn.parentElement.querySelector('.comment-input');
      if(!textarea) return;
      const postElem = btn.closest('.post');
      const postId = postElem.getAttribute('data-post-id');
      const val = textarea.value.trim();
      if(!val) return;
      fetch(`/api/posts/${postId}/comentarios`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({conteudo: val})
      }).then(() => {
        textarea.value = '';
        const commentBox = btn.closest('.comment-box');
        if(commentBox) commentBox.remove();
        const list = postElem.querySelector('.comments-list');
        const toggleBtn = postElem.querySelector('.toggle-comments-btn-perfil');
        if(list && list.style.display !== 'none') {
          loadCommentsPerfil(postId, postElem).then(count=>{
            if(toggleBtn) toggleBtn.textContent = count ? `↑ ${count}` : '↑';
          });
        } else {
          loadCommentsPerfil(postId, postElem, true).then(count=>{
            if(toggleBtn) toggleBtn.textContent = count ? `↓ ${count}` : '↓';
          });
        }
      });
    }

    function toggleCommentsPerfil(btn, postId) {
      const postElem = btn.closest('.post');
      const commentsDiv = postElem.querySelector('.comments-list');
      if (commentsDiv.style.display === 'none') {
        loadCommentsPerfil(postId, postElem).then(count => {
          commentsDiv.style.display = 'block';
          btn.textContent = count ? `↑ ${count}` : '↑';
        });
      } else {
        commentsDiv.style.display = 'none';
        btn.textContent = '↓';
      }
    }

    function loadCommentsPerfil(postId, postElem, silent=false) {
      return fetch(`/api/posts/${postId}/comentarios`)
        .then(res => res.json())
        .then(comments => {
          let commentsDiv = postElem.querySelector('.comments-list');
          if (!commentsDiv) {
            commentsDiv = document.createElement('div');
            commentsDiv.className = 'comments-list';
            commentsDiv.setAttribute('data-post-id', postId);
            commentsDiv.style.cssText = 'display:none;margin-top:.6rem;';
            postElem.appendChild(commentsDiv);
          }
          if(!Array.isArray(comments)) comments = [];
          if(comments.length === 0){
            commentsDiv.innerHTML = '<div style="font-size:.7rem;color:#888;padding:.4rem 0;">Nenhum comentário ainda.</div>';
          } else {
            commentsDiv.innerHTML = comments.map(c =>
              `<div style="padding:.5rem;border-left:2px solid #eee;margin-bottom:.4rem;">
                <div style="font-size:.7rem;"><strong>@${c.usuario}</strong> <span style="color:#888;">${(c.data||'').replace(' ',' · ')}</span></div>
                <p style="font-size:.7rem;margin:.2rem 0 0;white-space:pre-line;">${c.conteudo}</p>
              </div>`
            ).join('');
          }
          return comments.length;
        });
    }

    // Carregar postagens ao abrir o perfil
    document.addEventListener('DOMContentLoaded', ()=>{
      carregarPostagensUsuario();
      carregarContadores();
      const btn=document.getElementById('btn-follow');
      if(btn && btn.getAttribute('data-state')==='following') btn.style.background='#e57373';
    });

    // Delegação clique em seguidores/seguindo
    document.addEventListener('click', function(e){
      const seg = e.target.closest('.seg-item');
      if(seg){
        const uname = seg.getAttribute('data-username');
        if(uname === '{{ current_user.username }}'){
          window.location.href = '/perfil';
        } else {
          fetch(`/api/usuarios/username/${uname}`).then(r=>r.json()).then(u=>{ if(u.id) window.location.href = '/perfil/'+u.id; });
        }
      }
    });

    function abrirEdicaoPerfil() {
      document.getElementById('modal-editar').style.display = 'flex';
    }

    function fecharEdicaoPerfil() {
      document.getElementById('modal-editar').style.display = 'none';
    }

    if(document.getElementById('form-editar-perfil')){
      document.getElementById('form-editar-perfil').onsubmit = function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        fetch('/api/editar-perfil', { method:'POST', body: formData })
          .then(async response => {
            if (response.ok) { alert('Perfil atualizado com sucesso!'); location.reload(); }
            else { alert('Erro ao atualizar perfil.'); }
          });
      };
    }

    function carregarContadores(){
      const uid = '{{ usuario.id }}';
  fetch(`/api/seguidores/${uid}`).then(r=>r.json()).then(list=>{ document.getElementById('cnt-seguidores').innerHTML = `<b>${list.length}</b> seguidories`; });
      fetch(`/api/seguindo/${uid}`).then(r=>r.json()).then(list=>{ document.getElementById('cnt-seguindo').innerHTML = `<b>${list.length}</b> seguindo`; });
    }
    function toggleFollow(uid){
      const btn = document.getElementById('btn-follow');
      const seguindo = btn.getAttribute('data-state') === 'following';
      fetch(`/api/seguir/${uid}`, { method: seguindo ? 'DELETE':'POST' }).then(res=>{
        if(res.ok){
          if(seguindo){
            btn.textContent = 'Seguir';
            btn.setAttribute('data-state','not');
            btn.style.background = '#4a6fa5';
          } else {
            btn.textContent = 'Deixar de seguir';
            btn.setAttribute('data-state','following');
            btn.style.background = '#e57373';
          }
          carregarContadores();
        }
      });
    }

    // Image Modal for full-size view
    function ensureImageModal() {
      if(document.getElementById('image-modal')) return;
      const modal = document.createElement('div');
      modal.id = 'image-modal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:2000;';
      modal.innerHTML = `<div style="position:relative;max-width:95vw;max-height:95vh;display:flex;align-items:center;justify-content:center;">
        <button onclick="closeImageModal()" style="position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.9);border:none;border-radius:50%;width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,0.3);z-index:10;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <img id='image-modal-img' src='' alt='Imagem ampliada' style='max-width:100%;max-height:95vh;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);'/>
      </div>`;
      document.body.appendChild(modal);
      modal.addEventListener('click', e=>{ if(e.target===modal) closeImageModal(); });
    }
    function openImageModal(imageSrc){
      ensureImageModal();
      const modal = document.getElementById('image-modal');
      const img = document.getElementById('image-modal-img');
      img.src = imageSrc;
      modal.style.display='flex';
    }
    function closeImageModal(){
      const modal = document.getElementById('image-modal');
      if(modal) modal.style.display='none';
    }
  // já tratado no DOMContentLoaded consolidado acima
  </script>
</body>
</html>
