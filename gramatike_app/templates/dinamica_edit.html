<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Dinâmica — Gramátike Edu</title>
  <link href="https://fonts.googleapis.com/css2?family=Mansalva&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#9B5DE5; --border:#e5e7eb; --card:#fff; --bg:#f7f8ff; --text:#222; }
    * { box-sizing:border-box; }
    html, body { margin:0; padding:0; overflow-x:hidden; width:100%; max-width:100vw; }
    body { font-family:'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header.site-head { background:#9B5DE5; padding:28px clamp(16px,4vw,40px) 46px; border-bottom-left-radius:40px; border-bottom-right-radius:40px; position:relative; display:flex; flex-direction:column; align-items:center; }
    .logo { font-family:'Mansalva', cursive; font-size:2.4rem; color:#fff; font-weight:400; margin:0; }
    main { width:100%; max-width:980px; margin:2rem auto 4rem; padding:0 clamp(16px,4vw,40px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:1rem 1.2rem; box-shadow:0 10px 24px -8px rgba(0,0,0,.10); }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.6rem 1rem; border-radius:10px; border:1px solid var(--border); cursor:pointer; font-family:'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; font-weight:800; letter-spacing:.3px; background:#fff; color:#9B5DE5; text-decoration:none; transition:all .2s; }
    .btn:hover { background:#f7f2ff; transform:translateY(-1px); }
    .btn.primary { background:#9B5DE5; color:#fff; border:none; box-shadow:0 4px 12px rgba(155,93,229,.3); }
    .btn.primary:hover { background:#7d3dc9; transform:translateY(-1px); box-shadow:0 6px 16px rgba(155,93,229,.4); }
    .btn.danger { background:#fff; color:#d32f2f; border-color:#ffcdd2; }
    .btn.danger:hover { background:#ffebee; }
    .builder-card { background:#fff; border:1px solid var(--border); border-radius:16px; padding:1rem; margin:.6rem 0; box-shadow:0 2px 8px rgba(0,0,0,.04); transition:box-shadow .2s; }
    .builder-card:hover { box-shadow:0 4px 16px rgba(0,0,0,.08); }
    .builder-actions { display:flex; gap:.6rem; margin-top:1rem; }
    .muted-sm { font-size:.8rem; color:#666; }
    .opt-row { display:flex; gap:.4rem; align-items:center; margin:.25rem 0; }
    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .55rem; border-radius:14px; border:1px solid var(--border); background:#fafafa; font-size:.75rem; font-weight:800; color:#9B5DE5; }
    input[type="text"], textarea, select { border:1px solid var(--border); border-radius:8px; padding:.6rem .75rem; font-family:'Nunito', sans-serif; font-size:.9rem; transition:border .2s; }
    input[type="text"]:focus, textarea:focus, select:focus { outline:none; border-color:#9B5DE5; box-shadow:0 0 0 3px rgba(155,93,229,.1); }
    label { display:block; font-weight:700; color:#9B5DE5; margin-bottom:.4rem; font-size:.85rem; }
    @media (max-width: 768px) {
      header.site-head { padding:12px 16px 18px; }
      .logo { font-size:1.5rem; }
      main { padding:0 12px; }
    }
  </style>
</head>
<body>
  <header class="site-head">
    <h1 class="logo">Editar Dinâmica</h1>
  </header>
  <main>
    <div class="card">
      <h2 style="margin:0 0 .6rem; font-size:1.2rem; color:#9B5DE5;">Editar "{{ d.titulo }}"</h2>
      <form id="dynEditForm" method="POST" action="{{ url_for('main.dinamica_update', dyn_id=d.id) }}" enctype="multipart/form-data" style="display:grid; gap:.6rem; grid-template-columns:1fr; font-family:'Nunito', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
        
        <div style="padding:.6rem; background:#f0f0f0; border-radius:8px;">
          <strong>Tipo:</strong> <span class="chip">{{ d.tipo }}</span>
          <div class="muted-sm" style="margin-top:.3rem;">O tipo da dinâmica não pode ser alterado após criação.</div>
        </div>
        
        <label style="font-weight:800; color:#9B5DE5;">Título</label>
        <input type="text" name="titulo" value="{{ d.titulo }}" required />
        
        <label style="font-weight:800; color:#9B5DE5;">Descrição (opcional)</label>
        <textarea name="descricao" rows="2">{{ d.descricao or '' }}</textarea>
        
        {% if d.tipo == 'poll' %}
        <div id="poll_opts">
          <label style="font-weight:800; color:#9B5DE5;">Opções (1 por linha)</label>
          <textarea name="opcoes" rows="3" placeholder="Opção A&#10;Opção B">{{ '\n'.join(cfg.get('options', [])) }}</textarea>
        </div>
        {% elif d.tipo == 'form' %}
        <div id="form_builder">
          <div class="muted-sm">Edite as perguntas do formulário. Tipos: resposta curta, parágrafo, múltipla escolha.</div>
          <div id="q_list"></div>
          <div class="builder-actions">
            <button type="button" class="btn" id="add_q">+ Pergunta</button>
          </div>
          <input type="hidden" name="config_json" id="config_json" />
        </div>
        {% elif d.tipo == 'quemsouleu' %}
        <div id="quemsouleu_builder">
          <div class="muted-sm">Edite os itens da dinâmica "Quem soul eu"</div>
          <label style="font-weight:800; color:#9B5DE5; margin-top:.8rem;">O que a pessoa deve descobrir?</label>
          <input type="text" name="questao_tipo" id="questao_tipo" value="{{ cfg.get('questao_tipo', '') }}" placeholder="Ex: gênero, orientação sexual, pronome..." />
          <label style="font-weight:800; color:#9B5DE5; margin-top:.8rem;">Moral/Mensagem Final</label>
          <textarea name="moral" id="moral" rows="3" placeholder="Mensagem que aparecerá ao final da dinâmica...">{{ cfg.get('moral', '') }}</textarea>
          <div id="items_list" style="margin-top:1rem;"></div>
          <div class="builder-actions">
            <button type="button" class="btn" id="add_item">+ Item (Frase ou Foto)</button>
          </div>
          <input type="hidden" name="quemsouleu_config_json" id="quemsouleu_config_json" />
        </div>
        {% endif %}
        
        <div style="display:flex; gap:.6rem; margin-top:.4rem;">
          <button type="submit" class="btn primary">Salvar alterações</button>
          <a href="{{ url_for('main.dinamicas_home') }}" class="btn">Cancelar</a>
        </div>
      </form>
    </div>
  </main>
  
  {% if d.tipo == 'form' %}
  <script>
  (function(){
    const builder = document.getElementById('form_builder');
    const qList = document.getElementById('q_list');
    const addBtn = document.getElementById('add_q');
    const cfgEl = document.getElementById('config_json');
    const form = document.getElementById('dynEditForm');

    // Carregar campos existentes
    const existingFields = {{ cfg.get('fields', [])|tojson }};
    let seq = Math.max(...existingFields.map(f => f.id || 0), 0) + 1;
    const fields = existingFields.map(f => ({
      id: f.id,
      type: f.type || 'short',
      label: f.label || '',
      required: !!f.required,
      options: f.options || []
    }));

    function render(){
      qList.innerHTML='';
      fields.forEach((f, idx)=>{
        const card = document.createElement('div');
        card.className = 'builder-card';
        card.innerHTML = `
          <div style="display:grid; gap:.4rem;">
            <div style="display:flex; gap:.5rem; align-items:center;">
              <span class="chip">Q${idx+1}</span>
              <input type="text" placeholder="Pergunta" value="${f.label||''}" data-k="label" style="flex:1;"/>
              <select data-k="type">
                <option value="short" ${f.type==='short'?'selected':''}>Resposta curta</option>
                <option value="paragraph" ${f.type==='paragraph'?'selected':''}>Parágrafo</option>
                <option value="multiple_choice" ${f.type==='multiple_choice'?'selected':''}>Múltipla escolha</option>
              </select>
              <label class="muted-sm" style="display:flex; align-items:center; gap:.3rem;">
                <input type="checkbox" data-k="required" ${f.required?'checked':''}/> Obrigatória
              </label>
              <button type="button" class="btn" data-act="del">Remover</button>
            </div>
            <div data-role="options" style="${f.type==='multiple_choice'?'':'display:none;'}">
              <div class="muted-sm">Opções:</div>
              <div class="opt-list"></div>
              <button type="button" class="btn" data-act="addopt">+ opção</button>
            </div>
          </div>`;
        // bind
        card.querySelectorAll('input,select,textarea').forEach(el=>{
          el.addEventListener('change', (e)=>{
            const k = el.getAttribute('data-k');
            if(!k) return;
            if(k==='required'){ f.required = !!el.checked; }
            else if(k==='label'){ f.label = el.value; }
            else if(k==='type'){ f.type = el.value; card.querySelector('[data-role="options"]').style.display = (f.type==='multiple_choice')?'block':'none'; }
          });
        });
        card.querySelector('[data-act="del"]').addEventListener('click', ()=>{ fields.splice(idx,1); render(); });
        const optWrap = card.querySelector('.opt-list');
        function renderOpts(){
          optWrap.innerHTML = '';
          (f.options||[]).forEach((o, i)=>{
            const row = document.createElement('div');
            row.className = 'opt-row';
            row.innerHTML = `<span class="muted-sm">${String.fromCharCode(65+i)})</span> <input type="text" value="${o}" style="flex:1;"/> <button type="button" class="btn" data-i="${i}">remover</button>`;
            row.querySelector('input').addEventListener('input', (e)=>{ f.options[i] = e.target.value; });
            row.querySelector('button').addEventListener('click', ()=>{ f.options.splice(i,1); renderOpts(); });
            optWrap.appendChild(row);
          });
        }
        renderOpts();
        card.querySelector('[data-act="addopt"]').addEventListener('click', ()=>{ f.options = f.options||[]; f.options.push(''); renderOpts(); });
        qList.appendChild(card);
      });
    }
    function addQuestion(){
      fields.push({ id: seq++, type: 'short', label: '', required: false, options: [] });
      render();
    }
    addBtn && addBtn.addEventListener('click', addQuestion);
    // on submit serialize
    form.addEventListener('submit', ()=>{
      const cfg = { fields: fields.map(f=>({ id: f.id, type: f.type, label: f.label, required: !!f.required, options: (f.type==='multiple_choice'?(f.options||[]):undefined) })) };
      cfgEl.value = JSON.stringify(cfg);
    });
    // initial render
    render();
  })();
  </script>
  {% elif d.tipo == 'quemsouleu' %}
  <script>
  (function(){
    const itemsList = document.getElementById('items_list');
    const addItemBtn = document.getElementById('add_item');
    const quemsouleuCfgEl = document.getElementById('quemsouleu_config_json');
    const form = document.getElementById('dynEditForm');

    // Load existing items
    const existingItems = {{ cfg.get('items', [])|tojson }};
    let itemSeq = Math.max(...existingItems.map(i => i.id || 0), 0) + 1;
    const items = existingItems.map(i => ({
      id: i.id,
      tipo: i.tipo || 'frase',
      conteudo: i.conteudo || '',
      resposta_correta: i.resposta_correta || '',
      alternativas: i.alternativas || []
    }));

    function renderItems(){
      itemsList.innerHTML='';
      items.forEach((item, idx)=>{
        const card = document.createElement('div');
        card.className = 'builder-card';
        card.innerHTML = `
          <div style="display:grid; gap:.6rem;">
            <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
              <span class="chip" style="font-size:.85rem;">Item ${idx+1}</span>
              <select data-k="tipo" style="flex:0 0 auto;">
                <option value="frase" ${item.tipo==='frase'?'selected':''}>Frase</option>
                <option value="foto" ${item.tipo==='foto'?'selected':''}>Foto</option>
              </select>
              <button type="button" class="btn danger" data-act="del-item" style="margin-left:auto;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                </svg>
                Remover
              </button>
            </div>
            <div data-role="frase-input" style="${item.tipo==='frase'?'':'display:none;'}">
              <label>Frase</label>
              <textarea data-k="conteudo" rows="2" style="width:100%;">${item.conteudo||''}</textarea>
            </div>
            <div data-role="foto-input" style="${item.tipo==='foto'?'':'display:none;'}">
              <label>Foto</label>
              <input type="file" data-k="foto" data-item-id="${item.id}" accept="image/*" style="width:100%;" />
              ${item.conteudo ? `<div class="muted-sm" style="margin-top:.3rem;">Atual: <a href="${item.conteudo}" target="_blank" style="color:#9B5DE5;">ver foto</a></div>` : ''}
            </div>
            <div style="margin-top:.3rem;">
              <label>Resposta Correta Principal</label>
              <input type="text" data-k="resposta_correta" value="${item.resposta_correta||''}" style="width:100%;" placeholder="Ex: não-binário" />
              <div class="muted-sm" style="margin-top:.3rem;">Dica: Digite a resposta principal. Variações serão aceitas automaticamente.</div>
            </div>
            <div>
              <label>Respostas Alternativas Aceitas (opcional)</label>
              <input type="text" data-k="alternativas" value="${(item.alternativas||[]).join(', ')}" style="width:100%;" placeholder="Ex: nb, nao binario, não binaria, enby" />
              <div class="muted-sm" style="margin-top:.3rem;">Dica: Separe com vírgula. Aceita variações de gênero, acentos e abreviações.</div>
            </div>
          </div>`;
        
        // bind events
        card.querySelectorAll('input,select,textarea').forEach(el=>{
          el.addEventListener('change', (e)=>{
            const k = el.getAttribute('data-k');
            if(!k) return;
            if(k==='tipo'){ 
              item.tipo = el.value; 
              card.querySelector('[data-role="frase-input"]').style.display = (item.tipo==='frase')?'block':'none';
              card.querySelector('[data-role="foto-input"]').style.display = (item.tipo==='foto')?'block':'none';
            }
            else if(k==='conteudo'){ item.conteudo = el.value; }
            else if(k==='resposta_correta'){ item.resposta_correta = el.value; }
            else if(k==='alternativas'){ 
              // Parse comma-separated alternatives
              item.alternativas = el.value.split(',').map(s => s.trim()).filter(Boolean);
            }
            else if(k==='foto'){
              // Set name attribute for backend
              el.name = 'foto_' + item.id;
            }
          });
          // Set initial name for file inputs
          if(el.getAttribute('data-k') === 'foto'){
            el.name = 'foto_' + item.id;
          }
        });
        card.querySelector('[data-act="del-item"]').addEventListener('click', ()=>{ items.splice(idx,1); renderItems(); });
        itemsList.appendChild(card);
      });
    }

    function addItem(){
      items.push({ id: itemSeq++, tipo: 'frase', conteudo: '', resposta_correta: '', alternativas: [] });
      renderItems();
    }

    addItemBtn && addItemBtn.addEventListener('click', addItem);

    // on submit serialize
    form.addEventListener('submit', ()=>{
      const cfg = { items: items.map(item=>({ 
        id: item.id, 
        tipo: item.tipo, 
        conteudo: item.conteudo, 
        resposta_correta: item.resposta_correta || '',
        alternativas: item.alternativas || []
      })) };
      quemsouleuCfgEl.value = JSON.stringify(cfg);
    });

    // initial render
    renderItems();
  })();
  </script>
  {% endif %}
</body>
</html>
