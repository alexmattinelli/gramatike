<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gram√°tike Edu ‚Äî V√≠deos</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/icons/icon-192.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Mansalva&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary:#9B5DE5; --primary-dark:#7d3dc9; --bg:#f7f8ff; --card:#ffffff; --border:#e5e7eb; --text:#222; --text-dim:#666; }
    * { box-sizing:border-box; }
    html, body { margin:0; padding:0; overflow-x:hidden; width:100%; max-width:100vw; }
    body { font-family:'Nunito',system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.55; display:flex; flex-direction:column; min-height:100vh; }
    h1,h2,h3 { font-weight:800; margin:0 0 .9rem; line-height:1.12; }
    header.site-head { background:#9B5DE5; padding:28px clamp(16px,4vw,40px) 46px; border-bottom-left-radius:40px; border-bottom-right-radius:40px; position:relative; display:flex; flex-direction:column; align-items:center; }
    .logo { font-family:'Mansalva', cursive; font-size:2.6rem; color:#fff; letter-spacing:1px; font-weight:400; margin:0; }
    .edu-nav { margin-top:1.1rem; display:flex; flex-wrap:wrap; gap:.65rem; justify-content:center; }
  .edu-nav a { text-decoration:none; font-weight:700; font-size:.7rem; letter-spacing:.55px; padding:.65rem 1.05rem .62rem; background:#ffffff18; color:#fff; border:1px solid #ffffff30; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); border-radius:22px; display:inline-flex; align-items:center; gap:.35rem; box-shadow:0 4px 12px rgba(0,0,0,.18); transition:.25s; font-family:'Nunito',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif; }
    .edu-nav a:hover, .edu-nav a.active { background:#fff; color:#7d3dc9; }
    main { width:100%; max-width:1280px; margin:2rem auto 4rem; padding:0 clamp(12px,3vw,40px); flex:1; }
  .page-title { text-align:center; font-size:2.1rem; color:#9B5DE5; margin:0 0 1.8rem; letter-spacing:.5px; }
    .topics-bar { display:flex; flex-wrap:wrap; gap:.55rem; justify-content:center; margin:0 0 2rem; }
    .topics-bar a { text-decoration:none; font-size:.6rem; font-weight:800; letter-spacing:.6px; padding:.55rem .85rem .5rem; background:#f1edff; color:#6233B5; border:1px solid #e3daf9; border-radius:18px; box-shadow:0 2px 6px rgba(155,93,229,.18); }
    .topics-bar a:hover { background:#9B5DE5; color:#fff; border-color:#9B5DE5; }
  .search-box form { display:flex; gap:.55rem; max-width:860px; margin:0 auto 2.0rem; }
  .search-box input { flex:1; height:50px; border:1px solid var(--border); border-radius:20px; padding:0 1.15rem; font-size:.85rem; background:var(--card); font-weight:600; }
  .search-box button { height:50px; border:none; background:#9B5DE5; color:#fff; font-weight:700; font-size:.78rem; padding:0 1.4rem; border-radius:20px; cursor:pointer; letter-spacing:.45px; box-shadow:0 6px 20px rgba(155,93,229,.4); display:inline-flex; align-items:center; gap:.45rem; }
  .search-box button.icon-btn { width:50px; padding:0; justify-content:center; }
    .search-box button:hover { filter:brightness(1.07); }
  /* Grade 3x3 estilo podcasts: 3 colunas desktop, 2 m√©dio, 1 mobile */
  .videos-grid { display:grid; gap:1.4rem; grid-template-columns:repeat(3, 1fr); align-items:start; }
    .video-card { background:var(--card); border:1px solid var(--border); border-radius:26px; padding:1.1rem 1.15rem .95rem; position:relative; box-shadow:0 10px 24px -6px rgba(0,0,0,.10); transition:.3s; overflow:hidden; }
  /* Gradiente removido dos cards de v√≠deo */
  /* .video-card::before { content:""; position:absolute; inset:0; pointer-events:none; } */
    .video-card:hover { box-shadow:0 18px 46px -10px rgba(0,0,0,.28); transform:translateY(-3px); }
    .video-iframe, .video-card iframe { width:100%; aspect-ratio:16/9; border:0; border-radius:18px; background:#000; box-shadow:0 6px 18px -4px rgba(0,0,0,.4); }
    .thumb-wrap { border-radius:18px; overflow:hidden; position:relative; display:block; }
    .thumb-wrap img { width:100%; display:block; aspect-ratio:16/9; object-fit:cover; }
    .video-title { font-size:.9rem; font-weight:800; letter-spacing:.4px; color:#6233B5; margin:.7rem 0 .2rem; }
    .video-meta { font-size:.65rem; line-height:1.3; color:var(--text-dim); font-weight:600; }
    .item-menu-trigger { position:absolute; top:10px; right:10px; background:#f1edff; border:1px solid #d6c9f2; border-radius:18px; width:34px; height:34px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 10px rgba(155,93,229,.25); z-index:6; }
    .item-menu { position:absolute; top:46px; right:10px; background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 14px 40px -8px rgba(0,0,0,.25); padding:.35rem 0; min-width:170px; display:none; z-index:30; }
    .item-menu.show { display:block; }
    .item-menu button { all:unset; display:block; width:100%; font-size:.7rem; font-weight:700; letter-spacing:.4px; padding:.55rem .85rem .5rem; cursor:pointer; color:#444; }
    .item-menu button:hover { background:#f1edff; color:#6233B5; }
    .item-menu form button.danger { color:#b42318; }
    .item-menu form button.danger:hover { background:#ffe4e1; }
  footer { margin-top:4rem; background:#9B5DE5; color:#fff; text-align:center; padding:1.4rem 1rem 1.6rem; font-size:.75rem; letter-spacing:.5px; font-weight:700; border-top-left-radius:38px; border-top-right-radius:38px; }
  @media (max-width: 980px){ footer { display:none !important; } }
    /* Dialog */
    #editVideoDialog{ width:min(94vw, 900px); border:0; border-radius:24px; padding:0; box-shadow:0 30px 70px -10px rgba(0,0,0,.45); background:linear-gradient(140deg,#fff,#f5efff); }
    #editVideoDialog::backdrop{ background:rgba(13,20,33,.55); backdrop-filter: blur(4px); }
    #editVideoForm{ padding:1.1rem .9rem 1.4rem; display:grid; gap:.9rem; grid-template-columns:1fr; }
    #editVideoForm h3{ margin:.2rem 0 .2rem; font-size:1.18rem; letter-spacing:.3px; color:#6233B5; }
    #editVideoForm label{ display:block; font-size:.69rem; font-weight:800; letter-spacing:.55px; color:#4a4f66; text-transform:uppercase; }
    #editVideoForm input, #editVideoForm textarea, #editVideoForm select{ width:100%; padding:.65rem .75rem; border:1px solid #cfd7e2; border-radius:12px; background:#f9fbfd; font-size:.8rem; font-weight:600; }
    #editVideoForm textarea{ min-height:110px; }
    #editVideoForm menu{ padding-top:.4rem; display:flex; gap:.6rem; justify-content:flex-end; }
    #editVideoForm button[type=submit]{ background:#9B5DE5; border:0; color:#fff; font-weight:800; letter-spacing:.5px; font-size:.7rem; padding:.65rem 1.2rem; border-radius:14px; cursor:pointer; box-shadow:0 8px 22px -6px rgba(155,93,229,.6); }
    #editVideoForm button[type=submit]:hover{ filter:brightness(1.07); }
    #editVideoForm #ev_cancel{ background:#e7e9f4; border:0; padding:.65rem 1.1rem; border-radius:14px; font-weight:700; font-size:.68rem; cursor:pointer; }
    #editVideoForm #ev_cancel:hover{ background:#dde1ee; }
    #ev_thumb_preview img{ max-width:210px; border:1px solid #d9dfea; border-radius:12px; box-shadow:0 6px 18px -6px rgba(0,0,0,.28); }
    @media (min-width:920px){
      #editVideoForm{ grid-template-columns:1fr 1fr; }
      #editVideoForm h3, #editVideoForm menu, #ev_thumb_preview{ grid-column:1 / -1; }
    }
    @media (max-width:720px){
      .videos-grid { grid-template-columns:1fr; }
      header.site-head { padding:12px 18px 18px; }
      .logo { font-size:2.2rem; }
  .search-box form { flex-direction:column; }
  .search-box input { width:100%; }
    }
    @media (max-width:1100px) and (min-width:721px){
      .videos-grid { grid-template-columns:repeat(2,1fr); }
    }
  </style>
</head>
<body>
  <header class="site-head">
    <h1 class="logo">Gram√°tike Edu</h1>
    {% if current_user.is_authenticated and (current_user.is_admin or current_user.is_superadmin) %}
      <a href="{{ url_for('admin.dashboard') }}" style="position:absolute; top:14px; right:16px; background:#ffffff22; border:1px solid #ffffff42; color:#fff; padding:6px 10px; font-size:11px; font-weight:700; border-radius:8px; text-decoration:none; letter-spacing:.5px;">üõ†Ô∏è Painel</a>
    {% endif %}
    <nav class="edu-nav" aria-label="Se√ß√µes educacionais">
  <a href="{{ url_for('main.educacao') }}">üè† In√≠cio</a>
      <a href="{{ url_for('main.apostilas') }}">üìö Apostilas</a>
      <a href="{{ url_for('main.exercicios') }}">üß† Exerc√≠cios</a>
      <a href="{{ url_for('main.podcasts') }}">üéß Podcasts</a>
      <a href="{{ url_for('main.redacao') }}">‚úçÔ∏è Reda√ß√£o</a>
      <a href="{{ url_for('main.videos') }}" class="active">üé¨ V√≠deos</a>
      <a href="{{ url_for('main.artigos') }}">üìë Artigos</a>
    </nav>
  </header>
  <main>
  <!-- T√≠tulo removido a pedido -->
    {% if topics %}
      <div class="topics-bar">
        {% for t in topics %}<a href="#topico-{{ t.id }}">{{ t.nome }}</a>{% endfor %}
      </div>
    {% endif %}
    <div class="search-box">
      <form method="get" action="">
        <input type="text" name="q" value="{{ q }}" placeholder="Pesquisar t√≠tulo ou descri√ß√£o..." />
        <button type="submit" class="icon-btn" aria-label="Buscar" title="Buscar">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="11" cy="11" r="7"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </form>
    </div>
    <div class="videos-grid">
      {% for c in conteudos %}
        {% set extra = (c.extra | fromjson) if c.extra else None %}
        <div class="video-card" id="topico-{{ c.id }}">
          {% if current_user.is_authenticated and (current_user.is_admin or current_user.is_superadmin) %}
            <button class="item-menu-trigger" aria-label="Menu">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
              </svg>
            </button>
            <div class="item-menu" role="menu">
              <button type="button" data-edit="{{ c.id }}">Editar</button>
              <form method="POST" action="/admin/edu/content/{{ c.id }}/delete" onsubmit="return confirm('Excluir este v√≠deo?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
                <input type="hidden" name="next" value="{{ request.url }}" />
                <button type="submit" class="danger">Excluir</button>
              </form>
            </div>
          {% endif %}
          {% if extra and extra.thumb %}
            <div class="thumb-wrap" data-embed="{{ extra.video_embed if extra and extra.video_embed }}" data-url="{{ extra.tiktok_url if extra and extra.tiktok_url }}" style="cursor:pointer;">
              <img src="{{ url_for('static', filename=extra.thumb) if extra.thumb and not extra.thumb.startswith('http') else extra.thumb }}" alt="Thumb de {{ c.titulo }}" />
              <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
                <div style="width:62px; height:62px; background:rgba(0,0,0,.55); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                  <span style="color:#fff; font-size:24px; margin-left:2px;">‚ñ∂</span>
                </div>
              </div>
            </div>
          {% elif extra and extra.video_embed %}
            {% set ve = extra.video_embed %}
            {% if 'youtube.com/embed/' in ve or 'youtu.be/' in ve or 'watch?v=' in ve %}
              {# Evita carregar iframe YouTube direto para n√£o mostrar bloqueio; usa placeholder #}
              {% if 'youtube.com/embed/' in ve %}
                {% set vid = ve.split('/embed/')[1].split('?')[0] %}
              {% elif 'watch?v=' in ve %}
                {% set vid = ve.split('watch?v=')[1].split('&')[0] %}
              {% elif 'youtu.be/' in ve %}
                {% set vid = ve.split('youtu.be/')[1].split('?')[0] %}
              {% else %}
                {% set vid = '' %}
              {% endif %}
              <div class="thumb-wrap" data-embed="{{ ve }}" style="cursor:pointer;">
                <img src="https://i.ytimg.com/vi/{{ vid }}/hqdefault.jpg" alt="Thumb de {{ c.titulo }}" />
                <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;">
                  <div style="width:62px; height:62px; background:rgba(0,0,0,.55); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <span style="color:#fff; font-size:24px; margin-left:2px;">‚ñ∂</span>
                  </div>
                </div>
              </div>
            {% else %}
              <iframe class="video-iframe" title="V√≠deo incorporado" src="{{ ve }}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen loading="lazy" referrerpolicy="strict-origin-when-cross-origin"></iframe>
            {% endif %}
          {% elif extra and extra.tiktok_url %}
            <blockquote class="tiktok-embed" cite="{{ extra.tiktok_url }}" style="max-width:605px;min-width:325px;">
              <section>Veja no TikTok: <a href="{{ extra.tiktok_url }}" target="_blank" rel="noopener">{{ c.titulo }}</a></section>
            </blockquote>
            <script async src="https://www.tiktok.com/embed.js"></script>
          {% elif c.url %}
            <a href="{{ c.url }}" target="_blank" rel="noopener" style="display:inline-block; font-size:.7rem; font-weight:700; letter-spacing:.4px;">Abrir v√≠deo</a>
          {% else %}
            <div class="video-iframe" style="display:flex; align-items:center; justify-content:center; color:#999; font-size:.8rem;">Sem m√≠dia</div>
          {% endif %}
          <div class="video-title">{{ c.titulo }}</div>
          {% if c.extra and (c.extra | fromjson).author %}
            <div class="video-meta">Autore: {{ (c.extra | fromjson).author }}</div>
          {% endif %}
          {% if c.resumo %}<div class="video-meta">{{ c.resumo }}</div>{% endif %}
        </div>
      {% else %}
        <div class="video-card"><span style="font-size:.75rem; color:#666;">Nenhum v√≠deo publicado.</span></div>
      {% endfor %}
    </div>
    {% if current_user.is_authenticated and (current_user.is_admin or current_user.is_superadmin) %}
    <dialog id="editVideoDialog">
      <form id="editVideoForm" method="post" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}" />
        <h3>Editar V√≠deo</h3>
        <input type="hidden" name="content_id" id="ev_id" />
        <label>T√≠tulo</label>
        <input name="titulo" id="ev_titulo" required />
        <label>Autore</label>
        <input name="autor" id="ev_autor" />
        <label>Resumo</label>
        <textarea name="resumo" id="ev_resumo" rows="8" style="min-height:200px; resize:vertical;"></textarea>
        <label>URL do v√≠deo (YouTube/Vimeo/TikTok)</label>
        <input name="url" id="ev_url" />
        <label>T√≥pico</label>
        <select name="topic_id" id="ev_topic">
          <option value="">(T√≥pico)</option>
          {% for t in topics %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}
        </select>
        <div style="display:grid; grid-template-columns:1fr; gap:.6rem; margin-top:.6rem;">
          <div>
            <label style="text-transform:none; font-weight:700; letter-spacing:.2px;">Thumbnail (opcional)</label>
            <input type="file" name="thumb" id="ev_thumb" accept="image/*" />
          </div>
          <div id="ev_thumb_preview" style="display:none;">
            <div style="font-size:.62rem; font-weight:800; letter-spacing:.5px; color:#6233B5; margin-bottom:.25rem; text-transform:uppercase;">Thumbnail atual</div>
            <img id="ev_thumb_img" src="" alt="Thumb" />
            <label style="display:inline-flex; align-items:center; gap:.4rem; margin-left:6px; font-size:.65rem; font-weight:700; letter-spacing:.4px;">
              <input type="checkbox" id="ev_remove_thumb_chk" /> Remover
            </label>
          </div>
        </div>
        <menu>
          <button type="button" id="ev_cancel">Cancelar</button>
          <button type="submit">Salvar</button>
        </menu>
      </form>
    </dialog>
    {% endif %}
  </main>
  <footer>¬© 2025 Gram√°tike ‚Ä¢ Inclus√£o e G√™nero Neutro</footer>
  <script>
  (function(){
    // =============================
    // Configura√ß√£o / Helpers v√≠deo
    // =============================
  const FORCE_YT_FALLBACK = false; // false = usu√°rio pode assistir (iframe carregado sob demanda)
  const YT_MODE = 'click'; // 'click' = mostra thumbnail e s√≥ cria iframe ao clicar
  const YT_EMBED_TIMEOUT_MS = 0; // sem timeout para derrubar iframe

    function extractYouTubeIdFromUrl(raw){
      if(!raw) return null;
      try { raw = raw.trim(); } catch(_){ }
      let vid=null;
      if(/youtu\.be\//.test(raw)) vid = raw.split('youtu.be/')[1].split(/[?&#]/)[0];
      else if(/watch\?v=/.test(raw)) vid = raw.split('watch?v=')[1].split(/[?&#]/)[0];
      else if(/\/shorts\//.test(raw)) vid = raw.split('/shorts/')[1].split(/[?&#]/)[0];
      else if(/embed\//.test(raw)) {
        const m = raw.match(/embed\/([^?&#/]+)/); if(m) vid = m[1];
      }
      return vid && vid.length<=20? vid : null; // sanity simples
    }

    function buildYTThumb(vid){
      return `https://i.ytimg.com/vi/${vid}/hqdefault.jpg`;
    }

    function applyYouTubeFallback(card, vid, opts={ hideOriginal:true }){
      if(!card || !vid) return;
      if(card.querySelector('.yt-fallback')) return; // j√° existe
      const thumb = buildYTThumb(vid);
      const wrap = document.createElement('div');
      wrap.className='yt-fallback';
      wrap.style.cssText='border:1px solid #d8dce3;border-radius:18px;overflow:hidden;position:relative;aspect-ratio:16/9;background:#000;';
      wrap.innerHTML = `<img src='${thumb}' alt='Thumbnail do v√≠deo' loading='lazy' style='width:100%;height:100%;object-fit:cover;filter:brightness(.65);transition:.3s;'/>`+
        `<a href='https://www.youtube.com/watch?v=${vid}' target='_blank' rel='noopener' aria-label='Abrir v√≠deo no YouTube' style='position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff;text-decoration:none;letter-spacing:.5px;text-shadow:0 2px 4px #000;'>Abrir no YouTube ‚ñ∂</a>`;
      // Se havia iframe original e optamos por esconder
      if(opts.hideOriginal){
        const ifr = card.querySelector('iframe');
        if(ifr) ifr.style.display='none';
      }
      // Inserir no ponto onde estaria a m√≠dia: antes do t√≠tulo
      const title = card.querySelector('.video-title');
      (title? title.parentElement.insertBefore(wrap, title) : card.appendChild(wrap));
    }

    function forceFallbackForCard(card){
      if(card.querySelector('.yt-fallback')) return;
      // 1) Se houver iframe YouTube
      const ifr = card.querySelector('iframe');
      if(ifr){
        const vid = extractYouTubeIdFromUrl(ifr.getAttribute('src'));
        if(vid){ applyYouTubeFallback(card, vid, { hideOriginal:true }); return; }
      }
      // 1.5) Se houver thumb-wrap com data-embed YouTube
      const tw = card.querySelector('.thumb-wrap[data-embed]');
      if(tw){
        const vid = extractYouTubeIdFromUrl(tw.getAttribute('data-embed'));
        if(vid){ tw.remove(); applyYouTubeFallback(card, vid, { hideOriginal:false }); return; }
      }
      // 2) Se houver link YouTube
      const link=[...card.querySelectorAll('a')].find(a=>/youtu(\.be|be\.com|be)/i.test(a.href));
      if(link){
        const vid = extractYouTubeIdFromUrl(link.href);
        if(vid){
          // Remove link e aplica fallback
            link.remove();
            applyYouTubeFallback(card, vid);
        }
      }
    }

    // Tenta criar iframe para cards que s√≥ t√™m link YouTube (modo embed-first)
    function buildClickPlaceholder(card, vid){
      if(card.querySelector('.yt-click-wrapper') || card.querySelector('.yt-fallback')) return;
      const thumb = buildYTThumb(vid);
      const wrap = document.createElement('div');
      wrap.className='yt-click-wrapper';
      wrap.style.cssText='position:relative;aspect-ratio:16/9;border:1px solid #d8dce3;border-radius:18px;overflow:hidden;background:#000;cursor:pointer;';
      wrap.innerHTML=`<img src='${thumb}' alt='Thumbnail do v√≠deo' loading='lazy' style='width:100%;height:100%;object-fit:cover;filter:brightness(.65);transition:.35s;' />`+
        `<div style='position:absolute;inset:0;display:flex;align-items:center;justify-content:center;'>`+
        `<div style='width:68px;height:68px;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 3px #ffffff22;'>`+
        `<span style='color:#fff;font-size:28px;line-height:0;margin-left:3px;'>‚ñ∂</span>`+
        `</div></div>`+
        `<a href='https://www.youtube.com/watch?v=${vid}' target='_blank' rel='noopener' style='position:absolute;right:6px;bottom:6px;background:#6233B5;color:#fff;font-size:.55rem;font-weight:800;letter-spacing:.5px;padding:4px 6px;border-radius:6px;text-decoration:none;opacity:.9;'>Abrir</a>`;
      const title = card.querySelector('.video-title');
      (title? title.parentElement.insertBefore(wrap, title) : card.appendChild(wrap));
      wrap.addEventListener('click', e=>{
        if(e.target.tagName==='A') return; // link Abrir
        // Substitui por iframe
        const iframe = document.createElement('iframe');
        iframe.className='video-iframe';
        iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        iframe.loading='lazy';
        iframe.referrerPolicy='strict-origin-when-cross-origin';
        iframe.title='V√≠deo incorporado';
        iframe.src=`https://www.youtube-nocookie.com/embed/${vid}?rel=0&modestbranding=1&playsinline=1&autoplay=1`;
        let done=false;
        iframe.addEventListener('load',()=>{ done=true; });
        iframe.addEventListener('error',()=>{ if(!done) { applyYouTubeFallback(card, vid); } });
        // Timeout de seguran√ßa: se em X ms usu√°rio provavelmente veria bloqueio -> fallback
        setTimeout(()=>{ if(!done){ applyYouTubeFallback(card, vid); } }, 2500);
        wrap.replaceWith(iframe);
      }, { once:true });
    }

    // Normaliza√ß√£o de embeds para formatos oficiais e cabe√ßalhos menos bloqueados
    function normalizarIframe(f){
      if(!f) return;
      let src = f.getAttribute('src');
      if(!src) return;
      // for√ßa https
      if(src.startsWith('http://')) src = 'https://' + src.slice(7);
      try {
        // YouTube watch -> embed
        if(/youtube\.com\/watch\?v=/.test(src)){
          const u = new URL(src);
          const id = u.searchParams.get('v');
          if(id) src = `https://www.youtube.com/embed/${id}`;
        }
        // youtu.be curto -> embed
        if(/youtu\.be\//.test(src) && !/embed/.test(src)){
          const id = src.split('youtu.be/')[1].split(/[?&#]/)[0];
          if(id) src = `https://www.youtube.com/embed/${id}`;
        }
        // shorts -> embed
        if(/youtube\.com\/shorts\//.test(src)){
          const id = src.split('/shorts/')[1]?.split(/[?&#]/)[0];
          if(id) src = `https://www.youtube.com/embed/${id}`;
        }
        // remover par√¢metros sup√©rfluos si / feature / ab_channel etc.
        if(/youtube\.com\/embed\//.test(src)){
          const base = src.split('?')[0];
          const params = new URL(src.replace(/#.*/,'')).searchParams;
          const allowParams = new URLSearchParams();
          if(params.get('list')) allowParams.set('list', params.get('list'));
          const locOrigin = (location.protocol==='http:'||location.protocol==='https:') ? window.location.origin : '';
          const extra = 'rel=0&modestbranding=1&playsinline=1' + (locOrigin? '&origin='+encodeURIComponent(locOrigin):'');
          // For√ßa dom√≠nio nocookie
          const nocookieBase = base.replace('https://www.youtube.com/embed/','https://www.youtube-nocookie.com/embed/');
          src = nocookieBase + '?' + allowParams.toString() + (allowParams.toString()? '&':'') + extra;
        }
        // Vimeo direto -> player
        const vm = src.match(/vimeo\.com\/(\d+)/);
        if(vm && !/player\.vimeo\.com\/video\//.test(src)){
          src = `https://player.vimeo.com/video/${vm[1]}`;
        }
        // Spotify show/episode -> embed
        if(/open\.spotify\.com\/(episode|show)\//.test(src) && !/embed/.test(src)){
          const parts = src.split('/');
          const kindIndex = parts.findIndex(p=>p==='episode' || p==='show');
          if(kindIndex>-1 && parts[kindIndex+1]){
            const kind = parts[kindIndex];
            const id = parts[kindIndex+1].split('?')[0];
            src = `https://open.spotify.com/embed/${kind}/${id}?utm_source=generator`;
          }
        }
      } catch(e){}
      f.setAttribute('src', src);
      if(!f.hasAttribute('referrerpolicy')) f.setAttribute('referrerpolicy','strict-origin-when-cross-origin');
      if(!f.hasAttribute('title')) f.setAttribute('title','V√≠deo incorporado');
      // Fallback simples: se iframe emitir erro de carregamento (limitado cross-domain), mostra link
      f.addEventListener('error', ()=>{
        try {
          const parent = f.parentElement;
          if(parent){
            const safe = document.createElement('a');
            safe.textContent = 'Abrir v√≠deo';
            safe.href = src;
            safe.target = '_blank';
            safe.rel = 'noopener';
            safe.style.cssText = 'display:inline-block;font-size:.7rem;font-weight:700;letter-spacing:.4px;color:#6233B5;';
            parent.replaceChild(safe, f);
          }
        }catch(_){ }
      }, { once:true });
    }
    document.querySelectorAll('iframe.video-iframe, .video-card iframe').forEach(normalizarIframe);
    // Aplica√ß√£o do fallback for√ßado (ou opcional) para cada card YouTube
    // Reconstr√≥i embeds quando fallback n√£o √© desejado
    function ensureYouTubePlaceholder(card){
      if(card.querySelector('iframe')) return; // j√° tem player
      // Se existir fallback legado, converter em placeholder clic√°vel
      const fb = card.querySelector('.yt-fallback a[href*="watch?v="]');
      if(fb){
        const vid = extractYouTubeIdFromUrl(fb.href);
        if(vid){ card.querySelector('.yt-fallback').remove(); buildClickPlaceholder(card, vid); return; }
      }
      // Se existe thumb-wrap com data-embed YouTube e ainda n√£o tratada
      const tw = card.querySelector('.thumb-wrap[data-embed]');
      if(tw){
        const vid = extractYouTubeIdFromUrl(tw.getAttribute('data-embed'));
        if(vid && YT_MODE==='click'){ return; } // j√° √© placeholder visual (thumb-wrap)
      }
      // Link simples
      const link = [...card.querySelectorAll('a')].find(a=>/youtube\.com\/watch\?v=|youtu\.be\//i.test(a.href));
      if(link){
        const vid = extractYouTubeIdFromUrl(link.href);
        if(vid){ link.remove(); buildClickPlaceholder(card, vid); }
      }
    }
    if(FORCE_YT_FALLBACK){
      document.querySelectorAll('.video-card').forEach(card=> forceFallbackForCard(card));
    } else {
      document.querySelectorAll('.video-card').forEach(card=> ensureYouTubePlaceholder(card));
    }

    // Observer para futuros iframes/cards injetados dinamicamente
    const mo = new MutationObserver(muts=>{
      let needScan=false;
      muts.forEach(m=>{
        m.addedNodes.forEach(n=>{
          if(!(n instanceof HTMLElement)) return;
          if(n.matches && (n.matches('.video-card') || n.querySelector('.video-card'))){ needScan=true; }
          if(n.matches && n.matches('iframe')){ normalizarIframe(n); }
        });
      });
      if(needScan){
        if(FORCE_YT_FALLBACK){
          document.querySelectorAll('.video-card').forEach(card=> forceFallbackForCard(card));
        } else {
          document.querySelectorAll('.video-card').forEach(card=> ensureYouTubePlaceholder(card));
        }
      }
    });
    mo.observe(document.body, { childList:true, subtree:true });
    // Play
    // Remove comportamento de click-to-embed para YouTube; mant√©m TikTok se n√£o for YouTube
    // Converte iframes YouTube j√° presentes (embed direto) em placeholder se modo click
    function convertExistingYouTubeIframes(){
      if(FORCE_YT_FALLBACK || YT_MODE!=='click') return;
      document.querySelectorAll('.video-card iframe').forEach(ifr=>{
        const src = ifr.getAttribute('src')||'';
        if(/youtube\.com\/embed\//.test(src)){
          const id = (src.split('/embed/')[1]||'').split('?')[0];
          if(id){
            const card = ifr.closest('.video-card');
            if(card){
              // cria thumb placeholder
              const ph = buildClickPlaceholder(card, id);
              ifr.remove();
            }
          }
        }
      });
    }
    convertExistingYouTubeIframes();

    document.querySelectorAll('.video-card .thumb-wrap').forEach(el=>{
      el.addEventListener('click', ()=>{
        const tiktok = el.getAttribute('data-url');
        const embed = el.getAttribute('data-embed');
        if(tiktok){
          el.outerHTML = `<blockquote class=\"tiktok-embed\" cite=\"${tiktok}\" style=\"max-width:605px;min-width:325px;\"><section>Veja no TikTok: <a href=\"${tiktok}\" target=\"_blank\" rel=\"noopener\">Abrir</a></section></blockquote>`;
          const s=document.createElement('script'); s.src='https://www.tiktok.com/embed.js'; s.async=true; document.body.appendChild(s);
          return;
        }
        if(!FORCE_YT_FALLBACK && embed && /youtube|youtu\.be/.test(embed) && YT_MODE==='click'){
          const vid = extractYouTubeIdFromUrl(embed);
          if(vid){
            const iframe = document.createElement('iframe');
            iframe.className='video-iframe';
            iframe.title='V√≠deo incorporado';
            iframe.loading='lazy';
            iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen=true;
            iframe.src=`https://www.youtube.com/embed/${vid}?rel=0&modestbranding=1&playsinline=1&autoplay=1`;
            el.replaceWith(iframe);
          }
        }
      });
    });
    // Menu admin
    const grid=document.querySelector('.videos-grid');
    if(grid){
      grid.addEventListener('click', e=>{
        const trig=e.target.closest('.item-menu-trigger');
        if(trig){
          e.preventDefault();
            const card=trig.closest('.video-card');
            const menu=card.querySelector('.item-menu');
            const open=menu.classList.contains('show');
            document.querySelectorAll('.item-menu.show').forEach(m=>m.classList.remove('show'));
            if(!open) menu.classList.add('show');
            return;
        }
        if(!e.target.closest('.item-menu')){
          document.querySelectorAll('.item-menu.show').forEach(m=>m.classList.remove('show'));
        }
      });
      document.addEventListener('click', e=>{
        if(!e.target.closest('.video-card')){
          document.querySelectorAll('.item-menu.show').forEach(m=>m.classList.remove('show'));
        }
      });
    }
    // Dialog admin
    const dlg=document.getElementById('editVideoDialog');
    if(dlg){
      const form=document.getElementById('editVideoForm');
      const ev_id=document.getElementById('ev_id');
      const ev_titulo=document.getElementById('ev_titulo');
      const ev_autor=document.getElementById('ev_autor');
      const ev_resumo=document.getElementById('ev_resumo');
      const ev_url=document.getElementById('ev_url');
      const ev_topic=document.getElementById('ev_topic');
      const ev_cancel=document.getElementById('ev_cancel');
      const ev_thumb_preview=document.getElementById('ev_thumb_preview');
      const ev_thumb_img=document.getElementById('ev_thumb_img');
      const ev_remove_chk=document.getElementById('ev_remove_thumb_chk');
      document.querySelector('.videos-grid').addEventListener('click', async e=>{
        const btn=e.target.closest('[data-edit]');
        if(!btn) return;
        const id=btn.getAttribute('data-edit');
        try{
          const data=await fetch(`/admin/edu/content/${id}.json`, { credentials: 'same-origin' }).then(r=>r.json());
          ev_id.value=data.id; ev_titulo.value=data.titulo||''; ev_resumo.value=data.resumo||''; ev_autor.value=(data.extra && data.extra.author)?data.extra.author:''; ev_url.value=data.url||'';
          [...ev_topic.options].forEach(o=>o.selected=String(o.value)===String(data.topic_id||''));
          const th=data.extra && data.extra.thumb?data.extra.thumb:null;
          if(th){ ev_thumb_preview.style.display='block'; ev_thumb_img.src= th.startsWith('http')?th:`{{ url_for('static', filename='') }}${th}`; ev_remove_chk.checked=false; }
          else { ev_thumb_preview.style.display='none'; ev_thumb_img.src=''; ev_remove_chk.checked=false; }
          dlg.showModal();
        }catch(err){ alert('Falha ao carregar'); }
      });
      ev_cancel.addEventListener('click', ()=> dlg.close());
      form.addEventListener('submit', async e=>{
        e.preventDefault();
        const id=ev_id.value; const fd=new FormData(form); if(ev_remove_chk.checked) fd.append('remove_thumb','1');
        try{ const res=await fetch(`/admin/edu/content/${id}/update`, {method:'POST', body:fd, credentials: 'same-origin'}); if(res.ok){ dlg.close(); location.reload(); } else alert('Falha ao salvar'); }
        catch(err){ alert('Erro de rede'); }
      });
    }
  })();
  </script>
</body>
</html>